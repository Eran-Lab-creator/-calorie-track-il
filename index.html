<!DOCTYPE html>
<!--
    ========================================
    SUPABASE SETUP INSTRUCTIONS
    ========================================
    
    1. Create these tables in your Supabase project:
    
    ** profiles **
    CREATE TABLE profiles (
        id BIGSERIAL PRIMARY KEY,
        user_id UUID NOT NULL,
        daily_calorie_goal INTEGER DEFAULT 2000,
        current_weight DECIMAL(5,2),
        height DECIMAL(5,2),
        weight DECIMAL(5,2),
        age INTEGER,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW(),
        UNIQUE(user_id)
    );
    
    ** saved_meals **
    CREATE TABLE saved_meals (
        id BIGSERIAL PRIMARY KEY,
        user_id UUID NOT NULL,
        name TEXT NOT NULL,
        weight DECIMAL(8,2),
        calories INTEGER NOT NULL,
        protein DECIMAL(5,2) DEFAULT 0,
        icon TEXT,
        position INTEGER DEFAULT 0,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
    );
    CREATE INDEX idx_saved_meals_user ON saved_meals(user_id);
    CREATE INDEX idx_saved_meals_position ON saved_meals(user_id, position);
    
    ** daily_logs **
    CREATE TABLE daily_logs (
        id BIGSERIAL PRIMARY KEY,
        user_id UUID NOT NULL,
        date DATE NOT NULL,
        total_calories INTEGER DEFAULT 0,
        protein DECIMAL(5,2) DEFAULT 0,
        steps INTEGER DEFAULT 0,
        water INTEGER DEFAULT 0,
        meals JSONB DEFAULT '[]'::jsonb,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW(),
        UNIQUE(user_id, date)
    );
    CREATE INDEX idx_daily_logs_user_date ON daily_logs(user_id, date DESC);
    
    2. Update SUPABASE_URL and SUPABASE_ANON_KEY in the script below
    3. Enable Row Level Security (RLS) if needed
    
    ========================================
-->
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CalorieTrack IL - ◊û◊¢◊ß◊ë ◊ß◊ú◊ï◊®◊ô◊ï◊™ ◊ó◊õ◊ù</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&family=Assistant:wght@300;400;600;700;800&display=swap');
        
        /* ========================
           MODERN DARK EXECUTIVE THEME
        ======================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            /* Modern Dark Executive Colors */
            --bg-primary: #0A0E27;
            --bg-secondary: #121630;
            --bg-tertiary: #1A1F3A;
            
            /* Surface Layers - Layered Surface Design */
            --surface-1: rgba(255, 255, 255, 0.05);
            --surface-2: rgba(255, 255, 255, 0.08);
            --surface-3: rgba(255, 255, 255, 0.12);
            
            /* Accent Colors */
            --accent-primary: #8B5CF6;
            --accent-secondary: #8B5CF6;
            --accent-success: #10B981;
            --accent-warning: #F59E0B;
            --accent-error: #EF4444;
            
            /* Text with High Contrast */
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.5);
            
            /* Animation - Framer Motion Style */
            --ease-smooth: cubic-bezier(0.4, 0.0, 0.2, 1);
            --ease-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --transition-fast: 0.15s;
            --transition-normal: 0.3s;
            --transition-slow: 0.5s;
            
            /* Blur for Premium Feel */
            --blur-amount: 40px;
        }

        body {
            font-family: 'Heebo', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 16px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Sophisticated Gradient Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 50%),
                var(--bg-primary);
            z-index: -1;
            pointer-events: none;
        }

        /* ========================
           PREMIUM LAYERED SURFACE DESIGN
        ======================== */
        .glass-card {
            background: var(--surface-2);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.05) inset;
            transition: all var(--transition-normal) var(--ease-smooth);
            position: relative;
            overflow: hidden;
        }

        /* Modal inner cards must NOT clip the dropdown */
        #modalAddMeal .glass-card,
        #modalEditMeal .glass-card {
            overflow: visible;
        }
        /* But the ::before highlight still needs clipping - re-apply only to it */
        #modalAddMeal .glass-card::before,
        #modalEditMeal .glass-card::before {
            border-radius: 24px;
            overflow: hidden;
        }

        /* Subtle top highlight for premium feel */
        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.15) 50%, 
                transparent);
        }

        /* Haptic Feedback - Scale down on press */
        .glass-card:active {
            transform: scale(0.98);
            background: var(--surface-3);
        }

        .glass-card:hover {
            background: var(--surface-3);
            box-shadow: 
                0 24px 48px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.08) inset;
        }

        /* ========================
           PREMIUM BOTTOM NAVIGATION
        ======================== */
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all var(--transition-fast) var(--ease-smooth);
            color: var(--text-tertiary);
            position: relative;
        }

        /* Animated bottom indicator */
        .nav-item::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 20px;
            height: 3px;
            border-radius: 2px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: transform var(--transition-normal) var(--ease-smooth);
        }

        .nav-item.active {
            color: var(--text-primary);
            background: var(--surface-2);
        }

        .nav-item.active::before {
            transform: translateX(-50%) scaleX(1);
        }

        /* Haptic feedback simulation */
        .nav-item:active {
            transform: scale(0.9);
        }

        /* ========================
           PREMIUM METRIC CARDS
        ======================== */
        .metric-card {
            background: var(--surface-1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 20px;
            transition: all var(--transition-normal) var(--ease-smooth);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1) 50%, 
                transparent);
        }

        .metric-card:hover {
            background: var(--surface-2);
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
        }

        .metric-card:active {
            transform: scale(0.98);
        }

        /* ========================
           PREMIUM BUTTONS WITH HAPTIC FEEDBACK
        ======================== */
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 16px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all var(--transition-fast) var(--ease-smooth);
            box-shadow: 
                0 8px 24px rgba(99, 102, 241, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            position: relative;
            overflow: hidden;
        }

        /* Ripple effect */
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-primary:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary:hover {
            box-shadow: 
                0 12px 32px rgba(99, 102, 241, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.2) inset;
        }
        
        .btn-primary:active {
            transform: scale(0.95);
        }

        .btn-secondary {
            background: var(--surface-2);
            backdrop-filter: blur(20px);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all var(--transition-fast) var(--ease-smooth);
            position: relative;
            overflow: hidden;
        }

        .btn-secondary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-secondary:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-secondary:hover {
            background: var(--surface-3);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .btn-secondary:active {
            transform: scale(0.95);
        }

        /* ========================
           PREMIUM INPUT FIELDS
        ======================== */
        .input-glass {
            background: var(--surface-1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            padding: 14px 18px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            transition: all var(--transition-normal) var(--ease-smooth);
            width: 100%;
        }

        .input-glass::placeholder {
            color: var(--text-tertiary);
        }

        .input-glass:focus {
            outline: none;
            background: var(--surface-2);
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        select.input-glass {
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='rgba(255,255,255,0.5)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 16px center;
            padding-left: 40px;
        }

        /* ========================
           CUSTOM ICON DROPDOWN
        ======================== */
        .icon-dropdown {
            position: relative;
            width: 100%;
        }

        .icon-dropdown-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            text-align: right;
            border: none;
            font-size: 22px;
        }

        .icon-dropdown-trigger:focus {
            outline: none;
            background: var(--surface-2);
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
        }

        .icon-dropdown-selected {
            font-size: 24px;
            line-height: 1;
        }

        .icon-dropdown-arrow {
            font-size: 11px;
            opacity: 0.5;
            transition: transform 0.2s ease;
        }

        .icon-dropdown.open .icon-dropdown-arrow {
            transform: rotate(180deg);
        }

        .icon-dropdown-menu {
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            left: 0;
            z-index: 999;
            background: var(--bg-tertiary);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 14px;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            list-style: none;
            margin: 0;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(139, 92, 246, 0.15);
            max-height: 192px;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch; /* smooth iOS scroll */
            overscroll-behavior: contain;       /* prevent scroll bleed */
        }

        /* Opens upward when near bottom of screen */
        .icon-dropdown-menu.opens-up {
            top: auto;
            bottom: calc(100% + 6px);
            box-shadow: 0 -12px 40px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(139, 92, 246, 0.15);
        }

        .icon-dropdown-menu::-webkit-scrollbar {
            width: 4px;
        }
        .icon-dropdown-menu::-webkit-scrollbar-track {
            background: transparent;
        }
        .icon-dropdown-menu::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .icon-dropdown-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            padding: 8px 4px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: transparent;
            border: 2px solid transparent;
            line-height: 1;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .icon-dropdown-item:hover {
            background: var(--surface-2);
            box-shadow: 0 0 12px rgba(139, 92, 246, 0.35);
            transform: scale(1.12);
        }

        .icon-dropdown-item:active {
            transform: scale(0.95);
        }

        .icon-dropdown-item.selected {
            background: var(--surface-3);
            border-color: var(--accent-primary);
            box-shadow: 0 0 14px rgba(139, 92, 246, 0.45);
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        /* ========================
           PREMIUM MICRO-INTERACTIONS
        ======================== */
        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .fade-in {
            animation: fadeIn 0.5s var(--ease-smooth);
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        /* Slide from bottom animation - like native apps */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-up {
            animation: slideUp 0.4s var(--ease-smooth);
        }
        
        /* Notification animations */
        @keyframes slideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        @keyframes slideUpOut {
            from { opacity: 1; transform: translateX(-50%) translateY(0); }
            to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        /* ========================
           PREMIUM MEAL ITEMS
        ======================== */
        .meal-item {
            background: var(--surface-1);
            backdrop-filter: blur(20px);
            border-radius: 18px;
            padding: 18px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all var(--transition-normal) var(--ease-smooth);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .meal-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1) 50%, 
                transparent);
        }

        .meal-item:hover {
            background: var(--surface-2);
            transform: translateX(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .meal-item:active {
            transform: scale(0.98);
        }

        /* Staggered animation for meal list */
        .meal-item:nth-child(1) { animation-delay: 0.05s; }
        .meal-item:nth-child(2) { animation-delay: 0.1s; }
        .meal-item:nth-child(3) { animation-delay: 0.15s; }
        .meal-item:nth-child(4) { animation-delay: 0.2s; }
        .meal-item:nth-child(5) { animation-delay: 0.25s; }

        /* ========================
        /* ========================
           PREMIUM DELETE BUTTON
        ======================== */
        .delete-btn {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-error);
            border: 1px solid rgba(239, 68, 68, 0.2);
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            transition: all var(--transition-fast) var(--ease-smooth);
            font-weight: 600;
            font-size: 14px;
        }

        .delete-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .delete-btn:active {
            transform: scale(0.95);
        }

        /* ========================
           SORTABLE DRAG & DROP STYLES
           Native mobile-app floating feel
        ======================== */

        /* Ghost = invisible placeholder that holds space in the list */
        .sortable-ghost {
            opacity: 0 !important;
            background: transparent !important;
            border: 2px dashed rgba(139, 92, 246, 0.4) !important;
            border-radius: 18px !important;
            box-shadow: none !important;
        }

        /* The floating clone that follows the finger */
        .sortable-drag {
            opacity: 1 !important;
            /* Slight scale-up + subtle tilt = classic iOS "picked up" feel */
            transform: scale(1.05) rotate(-1deg) !important;
            box-shadow:
                0 8px  16px rgba(0,   0,   0,   0.25),
                0 24px 48px  rgba(0,   0,   0,   0.45),
                0 0   0 1.5px rgba(139, 92, 246, 0.55) inset !important;
            background: rgba(24, 22, 54, 0.98) !important;
            border: 1px solid rgba(139, 92, 246, 0.5) !important;
            border-radius: 18px !important;
            cursor: grabbing !important;
            z-index: 9999 !important;
            /* Smooth entry into "floating" state */
            transition: transform 0.12s cubic-bezier(0.2, 0, 0, 1.8),
                        box-shadow 0.12s ease !important;
        }

        /* Original item stays visible but dimmed while dragging */
        .sortable-chosen:not(.sortable-drag) {
            opacity: 0.45 !important;
            transition: opacity 0.15s ease !important;
        }

        /* Drag handle: purple tint when actively held */
        .drag-handle { touch-action: none; }
        .sortable-chosen .drag-handle {
            color: rgba(139, 92, 246, 0.9) !important;
            opacity: 1 !important;
        }

        /* ========================
           PREMIUM WATER TRACKER
        ======================== */
        /* ========================
           AI CAMERA BUTTON & ANIMATIONS
        ======================== */
        .ai-camera-button-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .ai-camera-button {
            position: relative;
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 
                0 20px 40px rgba(99, 102, 241, 0.4),
                0 0 0 0 rgba(99, 102, 241, 0.5);
            transition: all var(--transition-normal) var(--ease-smooth);
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0%, 100% {
                box-shadow: 
                    0 20px 40px rgba(99, 102, 241, 0.4),
                    0 0 0 0 rgba(99, 102, 241, 0.5);
            }
            50% {
                box-shadow: 
                    0 20px 60px rgba(99, 102, 241, 0.6),
                    0 0 0 20px rgba(99, 102, 241, 0);
            }
        }

        .ai-camera-button:hover {
            transform: scale(1.05);
            box-shadow: 
                0 25px 50px rgba(99, 102, 241, 0.5),
                0 0 0 0 rgba(99, 102, 241, 0.5);
        }

        .ai-camera-button:active {
            transform: scale(0.95);
        }

        /* AI Spinner */
        .ai-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 640px) {
            body {
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .glass-card {
                border-radius: 20px;
            }
            
            #app {
                padding-bottom: 140px !important;
            }
            
            .metric-card {
                padding: 14px;
            }
            
            h1 {
                font-size: 2rem !important;
            }
            
            h2 {
                font-size: 1.75rem !important;
            }
        }
        
        @media (min-width: 641px) {
            #app {
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                border-radius: 24px;
                background: rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px);
                margin-top: 20px;
                margin-bottom: 20px;
            }
        }
        
        /* Touch optimization */
        @media (hover: none) and (pointer: coarse) {
            .nav-item, .btn-primary, .btn-secondary, .meal-item {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
        }

        /* ========================
           AUTH SCREEN
        ======================== */
        #auth-screen {
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        #auth-screen.visible {
            display: flex;
        }

        .auth-card {
            background: var(--surface-2);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border-radius: 28px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 32px 64px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
            padding: 40px 32px;
            width: 100%;
            max-width: 420px;
        }

        .auth-logo {
            font-size: 48px;
            text-align: center;
            margin-bottom: 8px;
        }

        .auth-title {
            font-size: 26px;
            font-weight: 800;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 4px;
            background: linear-gradient(135deg, #fff 0%, rgba(139, 92, 246, 0.9) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-subtitle {
            font-size: 14px;
            color: var(--text-tertiary);
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-tabs {
            display: flex;
            background: var(--surface-1);
            border-radius: 14px;
            padding: 4px;
            margin-bottom: 24px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .auth-tab.active {
            background: var(--accent-primary);
            color: #fff;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .auth-error {
            background: rgba(239, 68, 68, 0.12);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            padding: 10px 14px;
            color: #fca5a5;
            font-size: 14px;
            margin-bottom: 16px;
            text-align: center;
            display: none;
        }

        .auth-error.visible { display: block; }

        .btn-logout {
            width: 100%;
            padding: 14px;
            border-radius: 14px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.08);
            color: #fca5a5;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-logout:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.5);
        }

        /* Bouncing dots loader */
        .auth-dots {
            display: inline-flex;
            gap: 4px;
            align-items: center;
            margin-right: 6px;
        }
        .auth-dots span {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: rgba(255,255,255,0.85);
            display: inline-block;
            animation: authBounce 0.9s infinite ease-in-out;
        }
        .auth-dots span:nth-child(2) { animation-delay: 0.15s; }
        .auth-dots span:nth-child(3) { animation-delay: 0.30s; }
        @keyframes authBounce {
            0%, 80%, 100% { transform: translateY(0); opacity: 0.5; }
            40%            { transform: translateY(-5px); opacity: 1; }
        }

        /* Success toast */
        .auth-success-toast {
            position: fixed;
            top: 28px;
            left: 50%;
            transform: translateX(-50%) translateY(-80px);
            z-index: 9999;
            background: rgba(15, 15, 35, 0.92);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.55);
            border-radius: 16px;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 0 1px rgba(139,92,246,0.15) inset;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
            white-space: nowrap;
        }
        .auth-success-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .auth-success-toast .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        .auth-success-toast .toast-text {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
        }
        .auth-success-toast .toast-sub {
            font-size: 12px;
            color: rgba(255,255,255,0.55);
            margin-top: 1px;
        }

        /* Password field wrapper */
        .password-field-wrap {
            position: relative;
        }
        .password-field-wrap .input-glass {
            padding-left: 46px;
        }
        .pw-toggle {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: rgba(255,255,255,0.45);
            transition: color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .pw-toggle:hover { color: rgba(255,255,255,0.85); }
        .pw-toggle svg { width: 18px; height: 18px; }

        /* --- Advanced 3.1 Donut CSS --- */
        .cyber-title {
            font-family: 'Assistant', sans-serif; /* Fallback to existing font */
            font-size: 32px;
            font-weight: 800;
            margin: 0;
            letter-spacing: 2px;
            text-align: center;
            background: linear-gradient(to bottom, #FFFFFF 0%, #A78BFA 50%, #8B5CF6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0px 5px 10px rgba(139, 92, 246, 0.4));
            animation: float-title 6s ease-in-out infinite;
        }
        @keyframes float-title {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        .donut-wrapper {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 0 auto;
        }
        .donut-center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none;
            z-index: 10;
            width: 100%;
        }
        .donut-value {
            font-size: 42px;
            font-weight: 700;
            line-height: 1;
            color: #FFFFFF;
            text-shadow: 0 0 20px rgba(139, 92, 246, 0.8);
            direction: ltr;
        }
        .donut-label {
            font-size: 14px;
            color: #94A3B8;
            margin-top: 5px;
            font-weight: 600;
        }
        .donut-remaining {
            color: #4ade80; 
            font-weight: 800;
            font-size: 16px;
            margin-top: 8px;
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.4);
            direction: rtl;
        }

        /* --- Advanced SVG Dashboard Chart CSS --- */
        .dashboard-chart-svg {
            width: 100%;
            height: auto;
            max-height: 250px;
        }
        .axis-text {
            font-family: 'Assistant', sans-serif;
            font-weight: 600;
            fill: #94A3B8;
            font-size: 12px;
        }
        .y-axis-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 10px;
            fill: #64748B;
        }
        .tdee-line-text {
            font-family: 'Rajdhani', sans-serif;
            fill: #4ade80;
            font-weight: 700;
            font-size: 12px;
            letter-spacing: 1px;
        }
        .bar-group {
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .bar-group:hover, .bar-group:active {
            opacity: 0.8;
        }
        /* Chart Tooltip */
        .chart-tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(139, 92, 246, 0.5);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-family: 'Assistant', sans-serif;
            font-size: 14px;
            font-weight: 600;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .chart-tooltip.visible {
            opacity: 1;
        }
        /* Animations */
        @keyframes growUp {
            from { height: 0; y: 180; opacity: 0; }
        }
        @keyframes pulseLine {
            0%, 100% { filter: drop-shadow(0 0 5px rgba(74, 222, 128, 0.5)); }
            50% { filter: drop-shadow(0 0 12px rgba(74, 222, 128, 1)); }
        }
    </style>
</head>
<body>
    <!-- Success Toast -->
    <div id="authSuccessToast" class="auth-success-toast">
        <div class="toast-icon">‚úÖ</div>
        <div>
            <div class="toast-text">◊î◊î◊®◊©◊û◊î ◊ë◊ï◊¶◊¢◊î ◊ë◊î◊¶◊ú◊ó◊î!</div>
            <div class="toast-sub">◊ë◊®◊ï◊ö ◊î◊ë◊ê ◊ú-CalorieTrack IL</div>
        </div>
    </div>

    <!-- Auth Screen (shown when not logged in) -->
    <div id="auth-screen" class="hidden" style="background: var(--bg-primary);">
        <div class="auth-card">
            <div class="auth-logo">üî•</div>
            <div class="auth-title">CalorieTrack IL</div>
            <div class="auth-subtitle">◊¢◊ß◊ï◊ë ◊ê◊ó◊® ◊î◊™◊ñ◊ï◊†◊î ◊©◊ú◊ö ◊ë◊¶◊ï◊®◊î ◊ó◊õ◊û◊î</div>

            <div class="auth-tabs">
                <button class="auth-tab active" id="tabLogin" onclick="switchAuthTab('login')">◊õ◊†◊ô◊°◊î</button>
                <button class="auth-tab" id="tabSignup" onclick="switchAuthTab('signup')">◊î◊®◊©◊û◊î</button>
            </div>

            <div id="authError" class="auth-error"></div>

            <div class="space-y-3">
                <div>
                    <label class="text-sm text-white opacity-70 mb-1 block">◊ê◊ô◊û◊ô◊ô◊ú</label>
                    <input type="email" id="authEmail" class="input-glass" placeholder="your@email.com" dir="ltr">
                </div>
                <div>
                    <label class="text-sm text-white opacity-70 mb-1 block">◊°◊ô◊°◊û◊î</label>
                    <div class="password-field-wrap">
                        <input type="password" id="authPassword" class="input-glass" placeholder="◊ú◊§◊ó◊ï◊™ 6 ◊™◊ï◊ï◊ô◊ù" dir="ltr">
                        <button type="button" class="pw-toggle" onclick="togglePwVisibility('authPassword', this)" tabindex="-1">
                            <svg id="authPasswordEyeIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="authConfirmDiv" class="hidden">
                    <label class="text-sm text-white opacity-70 mb-1 block">◊ê◊ô◊û◊ï◊™ ◊°◊ô◊°◊û◊î</label>
                    <div class="password-field-wrap">
                        <input type="password" id="authConfirm" class="input-glass" placeholder="◊ó◊ñ◊ï◊® ◊¢◊ú ◊î◊°◊ô◊°◊û◊î" dir="ltr">
                        <button type="button" class="pw-toggle" onclick="togglePwVisibility('authConfirm', this)" tabindex="-1">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <button id="authBtn" onclick="handleAuth()" class="btn-primary w-full mt-2" style="margin-top:8px;">
                    ◊õ◊†◊ô◊°◊î
                </button>
            </div>
        </div>
    </div>

    <!-- Main App (shown when logged in) -->
    <div id="app" class="max-w-md mx-auto pb-24 pt-6 px-4 relative hidden">
        <!-- Settings Icon (Top Left) -->
        <div class="absolute top-3 left-4 z-50">
            <button onclick="showSettings()" class="glass-card p-3 rounded-full text-white hover:scale-110 transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </button>
        </div>

        <!-- Main Content -->
        <div id="content" class="fade-in">
            <!-- Home Screen (Default) -->
            <div id="screen-home" class="screen">
                <div style="display: grid; grid-template-columns: 0.7fr auto 1.3fr; align-items: center; margin-bottom: 32px;">
                    <div></div>
                    <h1 class="cyber-title">
                        CALORIE TRACK
                    </h1>
                    <div></div>
                </div>

                <!-- Calorie Donut Chart -->
                <div class="glass-card p-6 rounded-3xl text-center mb-6">
                    <div class="donut-wrapper">
                        <div class="donut-center-text">
                            <span id="caloriesConsumedDisplay" class="donut-value">0</span>
                            <span class="donut-label">◊ß◊ú◊ï◊®◊ô◊ï◊™ ◊†◊¶◊®◊õ◊ï</span>
                            <span id="caloriesRemainingDisplay" class="donut-remaining">◊†◊ï◊™◊®◊ï: 2000</span>
                        </div>
                        <svg width="250" height="250" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <filter id="cinematic-bloom" x="-50%" y="-50%" width="200%" height="200%">
                                    <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur1" />
                                    <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur2" />
                                    <feGaussianBlur in="SourceGraphic" stdDeviation="20" result="blur3" />
                                    <feMerge>
                                        <feMergeNode in="blur3" />
                                        <feMergeNode in="blur2" />
                                        <feMergeNode in="blur1" />
                                        <feMergeNode in="SourceGraphic" />
                                    </feMerge>
                                </filter>
                                <linearGradient id="progressGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#D946EF" />
                                    <stop offset="50%" stop-color="#8B5CF6" />
                                    <stop offset="100%" stop-color="#06B6D4" />
                                </linearGradient>
                                <radialGradient id="plasmaGrad" cx="50%" cy="50%" r="50%">
                                    <stop offset="0%" stop-color="rgba(139, 92, 246, 0.4)" />
                                    <stop offset="70%" stop-color="rgba(139, 92, 246, 0.1)" />
                                    <stop offset="100%" stop-color="rgba(139, 92, 246, 0)" />
                                </radialGradient>
                            </defs>
                            <path fill="url(#plasmaGrad)" transform="translate(150, 150)">
                                <animate attributeName="d" dur="8s" repeatCount="indefinite"
                                         values="
                                            M 0 -80 C 40 -80, 80 -40, 80 0 C 80 40, 40 80, 0 80 C -40 80, -80 40, -80 0 C -80 -40, -40 -80, 0 -80 Z;
                                            M 0 -70 C 50 -90, 90 -30, 70 20 C 50 70, 20 90, -20 70 C -60 50, -90 10, -70 -30 C -50 -70, -30 -50, 0 -70 Z;
                                            M 0 -90 C 30 -70, 70 -50, 90 0 C 70 50, 30 70, 0 90 C -30 70, -70 50, -90 0 C -70 -50, -30 -70, 0 -90 Z;
                                            M 0 -80 C 40 -80, 80 -40, 80 0 C 80 40, 40 80, 0 80 C -40 80, -80 40, -80 0 C -80 -40, -40 -80, 0 -80 Z" 
                                         keyTimes="0; 0.33; 0.66; 1"/>
                            </path>
                            <circle cx="150" cy="150" r="135" fill="none" stroke="#4ade80" stroke-width="1" stroke-dasharray="2 10 50 15" opacity="0.3">
                                <animateTransform attributeName="transform" type="rotate" from="360 150 150" to="0 150 150" dur="30s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="150" cy="150" r="95" fill="none" stroke="#D946EF" stroke-width="1" stroke-dasharray="100 200" opacity="0.6">
                                <animateTransform attributeName="transform" type="rotate" from="0 150 150" to="360 150 150" dur="8s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="150" cy="150" r="115" fill="none" stroke="rgba(255, 255, 255, 0.05)" stroke-width="18" />
                            <circle cx="150" cy="150" r="115" fill="none" stroke="rgba(0, 0, 0, 0.5)" stroke-width="22" filter="blur(4px)" opacity="0.5"/>
                            <circle id="calorieDonutCircle" cx="150" cy="150" r="115" fill="none" 
                                    stroke="url(#progressGrad)" stroke-width="18" stroke-linecap="round" filter="url(#cinematic-bloom)"
                                    transform="rotate(-90 150 150)" stroke-dasharray="722" stroke-dashoffset="722">
                                <animate id="donutAnim" attributeName="stroke-dashoffset" from="722" to="722" dur="1.5s" fill="freeze" calcMode="spline" keySplines="0.25 0.1 0.25 1" />
                            </circle>
                        </svg>
                    </div>
                </div>

                <!-- Metrics Grid -->
                <div class="grid grid-cols-1 gap-4 mb-6">
                    <!-- Steps Counter -->
                    <div class="metric-card">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">üëü</div>
                                <div>
                                    <div class="text-sm text-white opacity-80">◊¶◊¢◊ì◊ô◊ù ◊î◊ô◊ï◊ù</div>
                                    <div class="text-2xl font-bold text-white" id="stepsCount">0</div>
                                </div>
                            </div>
                            <button onclick="showStepsPicker()" class="btn-secondary text-sm">◊î◊ï◊°◊£</button>
                        </div>
                        <div class="mt-3 bg-white/20 rounded-full h-2">
                            <div id="stepsProgress" class="bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        <div class="text-xs text-white opacity-60 mt-1">◊ô◊¢◊ì: 10,000 ◊¶◊¢◊ì◊ô◊ù</div>
                    </div>

                </div>
            </div>

            <!-- Dashboard Screen -->
            <div id="screen-dashboard" class="screen hidden">
                <h2 class="text-3xl font-bold text-white mb-6 text-center" style="font-family: 'Assistant', sans-serif;">◊ì◊©◊ë◊ï◊®◊ì ◊©◊ë◊ï◊¢◊ô</h2>
                
                <!-- Week Navigation -->
                <div class="glass-card p-4 mb-3 flex items-center justify-between">
                    <button onclick="previousWeek()" class="btn-secondary flex-shrink-0">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <div class="text-white font-semibold text-center flex-1 text-sm sm:text-base whitespace-nowrap px-2" id="weekDisplay">08/02/26 - 14/02/26</div>
                    <button onclick="nextWeek()" class="btn-secondary flex-shrink-0">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>

                <!-- Weekly Chart -->
                <div class="glass-card p-6 mb-3">
                    <div class="text-center mb-2">
                       <span class="text-sm font-semibold text-green-400">TDEE: </span>
                       <span id="tdeeDisplay" class="text-sm font-semibold text-green-400">2000</span>
                    </div>
                    <div id="weeklyChartSVGContainer" class="relative w-full flex justify-center" style="height: 250px;">
                        <!-- Tooltip for hovering over bars -->
                        <div id="chartTooltip" class="chart-tooltip"></div>
                        <svg id="weeklyChartSVG" class="dashboard-chart-svg" viewBox="0 0 370 220" preserveAspectRatio="xMidYMid meet">
                            <defs>
                                <linearGradient id="solidGrad" x1="0%" y1="100%" x2="0%" y2="0%">
                                    <stop offset="0%" stop-color="#3B82F6" />
                                    <stop offset="50%" stop-color="#8B5CF6" />
                                    <stop offset="100%" stop-color="#D946EF" />
                                </linearGradient>
                                <filter id="softGlow" x="-20%" y="-20%" width="140%" height="140%">
                                    <feGaussianBlur stdDeviation="4" result="blur" />
                                    <feMerge>
                                        <feMergeNode in="blur" />
                                        <feMergeNode in="SourceGraphic" />
                                    </feMerge>
                                </filter>
                            </defs>
                            <!-- Y-axis grid lines (5 lines: 0%, 25%, 50%, 75%, 100%) -->
                            <!-- Bottom: 0% at y=180 -->
                            <line x1="40" y1="180" x2="320" y2="180" stroke="rgba(255,255,255,0.1)" stroke-width="1" />
                            <text x="28" y="183" text-anchor="end" class="y-axis-text">0</text>
                            
                            <!-- 25% at y=138.75 -->
                            <line x1="40" y1="138.75" x2="320" y2="138.75" stroke="rgba(255,255,255,0.05)" stroke-width="1" stroke-dasharray="2 4" />
                            <text x="28" y="141.75" text-anchor="end" class="y-axis-text">600</text>
                            
                            <!-- 50% at y=97.5 -->
                            <line x1="40" y1="97.5" x2="320" y2="97.5" stroke="rgba(255,255,255,0.05)" stroke-width="1" stroke-dasharray="2 4" />
                            <text x="28" y="100.5" text-anchor="end" class="y-axis-text">1200</text>
                            
                            <!-- 75% at y=56.25 -->
                            <line x1="40" y1="56.25" x2="320" y2="56.25" stroke="rgba(255,255,255,0.05)" stroke-width="1" stroke-dasharray="2 4" />
                            <text x="28" y="59.25" text-anchor="end" class="y-axis-text">1800</text>
                            
                            <!-- Top: 100% at y=15 -->
                            <line x1="40" y1="15" x2="320" y2="15" stroke="rgba(255,255,255,0.05)" stroke-width="1" stroke-dasharray="2 4" />
                            <text x="28" y="18" text-anchor="end" class="y-axis-text">2400</text>
                            
                            <g id="tdeeLineGroup" style="animation: pulseLine 3s infinite;">
                                <line x1="40" y1="70" x2="320" y2="70" stroke="#4ade80" stroke-width="2" stroke-dasharray="8 6" />
                                <rect x="325" y="60" width="40" height="20" rx="4" fill="rgba(74, 222, 128, 0.1)" stroke="#4ade80" stroke-width="1"/>
                                <text id="tdeeLineLabel" x="345" y="74" class="tdee-line-text" text-anchor="middle">TDEE</text>
                            </g>
                            <g id="weeklyBarsGroup"></g>
                        </svg>
                    </div>
                </div>

                <!-- Weekly Summary -->
                <div id="weeklySummarySection" class="glass-card p-3 mb-10">
                    <h3 class="text-base font-bold text-white mb-2">◊°◊ô◊õ◊ï◊ù ◊©◊ë◊ï◊¢◊ô</h3>
                    <div class="space-y-1.5">
                        <div class="flex justify-between text-white text-sm">
                            <span class="opacity-80">◊û◊û◊ï◊¶◊¢ ◊ô◊ï◊û◊ô:</span>
                            <span class="font-bold" id="avgDaily">0</span>
                        </div>
                        <div class="flex justify-between text-white text-sm">
                            <span class="opacity-80">◊°◊î"◊õ ◊©◊ë◊ï◊¢◊ô:</span>
                            <span class="font-bold" id="totalWeekly">0</span>
                        </div>
                        <div class="flex justify-between text-white text-sm">
                            <span class="opacity-80">◊í◊®◊¢◊ï◊ü/◊¢◊ï◊ì◊£ ◊ß◊ú◊ï◊®◊ô◊ï◊™:</span>
                            <span class="font-bold" id="weeklyDeficit">0</span>
                        </div>
                    </div>
                </div>

                <!-- Day Detail View (hidden by default) -->
                <div id="dayDetailView" class="hidden">
                    <!-- Back Button -->
                    <button onclick="closeDayDetail()" class="btn-secondary mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        ◊ó◊ñ◊ï◊®
                    </button>

                    <!-- Day Title -->
                    <div class="glass-card p-6 mb-6">
                        <h3 class="text-2xl font-bold text-white text-center" id="dayDetailTitle">◊ô◊ï◊ù ◊®◊ê◊©◊ï◊ü, 08/02/2026</h3>
                        <div class="text-center text-white opacity-70 mt-2">
                            <span id="dayDetailCalories">0</span> ◊ß◊ú◊ï◊®◊ô◊ï◊™ ‚Ä¢ 
                            <span id="dayDetailProtein">0</span>g ◊ó◊ú◊ë◊ï◊ü
                        </div>
                    </div>

                    <!-- Meals List -->
                    <div class="glass-card p-6">
                        <h4 class="text-xl font-bold text-white mb-4">◊û◊†◊ï◊™ ◊î◊ô◊ï◊ù</h4>
                        <div id="dayDetailMeals" class="space-y-3">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Daily Tracking Screen -->
            <div id="screen-daily" class="screen hidden">
                <h2 class="text-3xl font-bold text-white mb-6 text-center" style="font-family: 'Assistant', sans-serif;">◊û◊¢◊ß◊ë ◊ô◊ï◊û◊ô</h2>
                
                <!-- Add Buttons -->
                <div class="flex gap-3 mb-6">
                    <button onclick="showAddFromSaved()" class="btn-primary flex-1 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        ◊î◊ï◊°◊£ ◊û◊û◊†◊ï◊™ ◊ß◊ë◊ï◊¢◊ï◊™
                    </button>
                    <button onclick="showAddManual()" class="btn-secondary flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        ◊û◊†◊î ◊ó◊ì◊©◊î
                    </button>
                </div>

                <!-- Today's Meals -->
                <div class="glass-card p-6 mb-10">
                    <h3 class="text-xl font-bold text-white mb-4">◊û◊†◊ï◊™ ◊î◊ô◊ï◊ù</h3>
                    <div id="todayMeals" class="space-y-3">
                        <div class="text-white opacity-60 text-center py-8">◊¢◊ì◊ô◊ô◊ü ◊ú◊ê ◊†◊ï◊°◊§◊ï ◊û◊†◊ï◊™ ◊ú◊î◊ô◊ï◊ù</div>
                    </div>
                </div>
            </div>

            <!-- Saved Meals Screen -->
            <div id="screen-meals" class="screen hidden">
                <h2 class="text-3xl font-bold text-white mb-6 text-center" style="font-family: 'Assistant', sans-serif;">◊û◊†◊ï◊™ ◊ß◊ë◊ï◊¢◊ï◊™</h2>
                
                <!-- Hidden CSV file input -->
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importFromCSV(event)">
                
                <!-- Action Buttons -->
                <div class="flex gap-3 mb-6">
                    <button onclick="showAddMeal()" class="btn-primary flex-1 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        ◊î◊ï◊°◊£ ◊û◊†◊î ◊ó◊ì◊©◊î
                    </button>
                    <button onclick="document.getElementById('csvFileInput').click()" class="btn-secondary flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        ◊ô◊ô◊ë◊ê CSV
                    </button>
                </div>

                <div id="savedMealsList" class="space-y-3">
                    <!-- Will be populated by JS -->
                </div>

                <div class="text-center text-white opacity-60 text-sm mt-4">
                    <span id="mealCount">0</span>/40 ◊û◊†◊ï◊™
                </div>
            </div>

            <!-- AI Screen -->
            <div id="screen-ai" class="screen hidden">
                <h2 class="text-3xl font-bold text-white mb-6 text-center" style="font-family: 'Assistant', sans-serif;">◊°◊®◊ô◊ß◊™ AI</h2>
                
                <!-- Mode Toggle Switch -->
                <div class="glass-card p-2 mb-6 flex gap-2">
                    <button id="modePlate" onclick="switchAIMode('plate')" class="flex-1 py-3 px-4 rounded-xl font-semibold transition-all bg-white/10 text-white">
                        ◊¶◊ú◊ó◊™
                    </button>
                    <button id="modeRecipe" onclick="switchAIMode('recipe')" class="flex-1 py-3 px-4 rounded-xl font-semibold transition-all text-white opacity-60">
                        ◊û◊™◊õ◊ï◊ü
                    </button>
                </div>

                <!-- PLATE MODE -->
                <div id="plateModeContent">
                    <!-- AI Camera Scan Area -->
                    <div id="aiScanArea" class="glass-card p-10 text-center mb-10">
                        <div class="ai-camera-button-container mb-6">
                            <button id="aiCameraBtn" onclick="triggerAICamera()" class="ai-camera-button">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                    <circle cx="12" cy="13" r="4"></circle>
                                </svg>
                            </button>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-2" style="font-family: 'Assistant', sans-serif;">◊°◊®◊ô◊ß◊™ ◊û◊†◊î ◊ë◊ê◊û◊¶◊¢◊ï◊™ AI</h3>
                        <p class="text-white opacity-70 mb-8">◊¶◊ú◊û◊ï ◊ê◊™ ◊î◊¶◊ú◊ó◊™ ◊©◊ú◊õ◊ù ◊ï◊î-AI ◊ô◊ñ◊î◊î ◊ê◊™ ◊î◊û◊®◊õ◊ô◊ë◊ô◊ù ◊ï◊î◊ß◊ú◊ï◊®◊ô◊ï◊™</p>

                        <!-- Camera / Gallery buttons -->
                        <div class="flex gap-3">
                            <button onclick="triggerAICamera()" class="btn-primary flex-1 flex items-center justify-center gap-2 py-4">
                                <!-- Camera icon -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                    <circle cx="12" cy="13" r="4"></circle>
                                </svg>
                                <span>◊û◊¶◊ú◊û◊î</span>
                            </button>
                            <button onclick="triggerAIGallery()" class="btn-secondary flex-1 flex items-center justify-center gap-2 py-4">
                                <!-- Gallery icon -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                <span>◊í◊ú◊®◊ô◊î</span>
                            </button>
                        </div>
                    </div>

                    <!-- Processing State (hidden by default) -->
                    <div id="aiProcessingArea" class="glass-card p-12 text-center hidden">
                        <div class="ai-spinner mb-6"></div>
                        <h3 class="text-2xl font-bold text-white mb-3" style="font-family: 'Assistant', sans-serif;">◊î-AI ◊û◊†◊™◊ó ◊ê◊™ ◊î◊û◊†◊î ◊©◊ú◊ö...</h3>
                        <p class="text-white opacity-70">◊ê◊†◊ê ◊î◊û◊™◊ü, ◊ñ◊î ◊ô◊ô◊ß◊ó ◊õ◊û◊î ◊©◊†◊ô◊ï◊™</p>
                    </div>

                    <!-- Success Result (hidden by default) -->
                    <div id="aiResultArea" class="glass-card p-8 hidden">
                        <div class="text-center mb-6">
                            <div class="text-5xl mb-4">‚úÖ</div>
                            <h3 class="text-2xl font-bold text-white mb-2" style="font-family: 'Assistant', sans-serif;">◊ñ◊ï◊î◊î ◊ë◊î◊¶◊ú◊ó◊î!</h3>
                        </div>
                        <div id="aiResultContent" class="bg-white/5 rounded-2xl p-6 text-right mb-6">
                            <!-- Will be populated by JS -->
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="space-y-3 mb-6">
                            <button onclick="addToTodayFromAI()" class="btn-primary w-full flex items-center justify-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                <span>◊î◊ï◊°◊£ ◊ú◊ô◊ï◊û◊ü ◊î◊ô◊ï◊ù</span>
                            </button>
                            
                            <button onclick="saveToLibraryFromAI()" class="btn-secondary w-full flex items-center justify-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                </svg>
                                <span>◊©◊û◊ï◊® ◊õ◊û◊†◊î ◊ß◊ë◊ï◊¢◊î</span>
                            </button>
                        </div>
                        
                        <button onclick="resetAIScan()" class="btn-secondary w-full opacity-70">◊°◊®◊ï◊ß ◊û◊†◊î ◊†◊ï◊°◊§◊™</button>
                    </div>

                    <!-- Camera input: capture="environment" opens rear camera directly -->
                    <input type="file" id="aiCameraInput"  accept="image/*" capture="environment" class="hidden" onchange="handleAIImageUpload(event)">
                    <!-- Gallery input: no capture attribute = photo library picker -->
                    <input type="file" id="aiGalleryInput" accept="image/*" class="hidden" onchange="handleAIImageUpload(event)">
                </div>

                <!-- RECIPE MODE -->
                <div id="recipeModeContent" class="hidden">
                    <!-- Recipe Input Area -->
                    <div id="recipeInputArea" class="space-y-4 mb-10">
                        <!-- Method A: Text Input -->
                        <div class="glass-card p-6">
                            <h3 class="text-xl font-bold text-white mb-4 text-center">◊©◊ô◊ò◊î ◊ê': ◊†◊ô◊™◊ï◊ó ◊ò◊ß◊°◊ò</h3>
                            <textarea id="recipeTextInput" class="input-glass w-full h-40 resize-none" placeholder="◊î◊ì◊ë◊ß ◊ê◊™ ◊®◊õ◊ô◊ë◊ô ◊î◊û◊™◊õ◊ï◊ü...&#10;&#10;◊ú◊ì◊ï◊í◊û◊î:&#10;200 ◊í◊®◊ù ◊ß◊û◊ó&#10;3 ◊ë◊ô◊¶◊ô◊ù&#10;100 ◊û◊¥◊ú ◊ó◊ú◊ë&#10;50 ◊í◊®◊ù ◊ó◊û◊ê◊î"></textarea>
                            <button onclick="analyzeRecipeText()" class="btn-primary w-full mt-3">◊†◊™◊ó ◊ò◊ß◊°◊ò</button>
                        </div>

                        <!-- Method B: Image Upload -->
                        <div class="glass-card p-6 text-center">
                            <h3 class="text-xl font-bold text-white mb-4">◊©◊ô◊ò◊î ◊ë': ◊î◊¢◊ú◊ê◊™ ◊™◊û◊ï◊†◊î</h3>
                            <button onclick="triggerRecipeImageUpload()" class="btn-secondary mx-auto flex items-center justify-center" style="width: 56px; height: 56px; border-radius: 16px; padding: 0;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                            </button>
                            <input type="file" id="recipeImageInput" accept="image/*" class="hidden" onchange="handleRecipeImageUpload(event)">
                        </div>
                    </div>

                    <!-- Recipe Processing State -->
                    <div id="recipeProcessingArea" class="glass-card p-12 text-center hidden">
                        <div class="ai-spinner mb-6"></div>
                        <h3 class="text-2xl font-bold text-white mb-3" style="font-family: 'Assistant', sans-serif;">◊î-AI ◊û◊†◊™◊ó ◊ê◊™ ◊î◊û◊™◊õ◊ï◊ü...</h3>
                        <p class="text-white opacity-70">◊ê◊†◊ê ◊î◊û◊™◊ü, ◊ñ◊î ◊¢◊©◊ï◊ô ◊ú◊ß◊ó◊™ ◊û◊°◊§◊® ◊©◊†◊ô◊ï◊™</p>
                    </div>

                    <!-- Recipe Result Area -->
                    <div id="recipeResultArea" class="glass-card p-8 hidden">
                        <div class="text-center mb-6">
                            <div class="text-5xl mb-4">‚úÖ</div>
                            <h3 class="text-2xl font-bold text-white mb-2" style="font-family: 'Assistant', sans-serif;">◊î◊û◊™◊õ◊ï◊ü ◊†◊ï◊™◊ó ◊ë◊î◊¶◊ú◊ó◊î!</h3>
                        </div>
                        <div id="recipeResultContent" class="bg-white/5 rounded-2xl p-6 text-right mb-6">
                            <!-- Will be populated by JS -->
                        </div>
                        
                        <!-- Action Buttons for Recipe -->
                        <div class="space-y-3 mb-6">
                            <button onclick="addRecipeToTodayFromAI()" class="btn-primary w-full flex items-center justify-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                <span>◊î◊ï◊°◊£ ◊ú◊ô◊ï◊û◊ü ◊î◊ô◊ï◊ù</span>
                            </button>
                            
                            <button onclick="saveRecipeToLibraryFromAI()" class="btn-secondary w-full flex items-center justify-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                </svg>
                                <span>◊©◊û◊ï◊® ◊õ◊û◊†◊î ◊ß◊ë◊ï◊¢◊î</span>
                            </button>
                        </div>
                        
                        <button onclick="resetRecipeAnalysis()" class="btn-secondary w-full opacity-70">◊†◊™◊ó ◊û◊™◊õ◊ï◊ü ◊†◊ï◊°◊£</button>
                    </div>
                </div>
            </div>

            <!-- Settings Screen -->
            <div id="screen-settings" class="screen hidden">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-white" style="font-family: 'Assistant', sans-serif;">◊î◊í◊ì◊®◊ï◊™</h2>
                </div>

                <div class="space-y-4">
                    <!-- Account Info -->
                    <div class="glass-card p-6">
                        <h3 class="text-xl font-bold text-white mb-3">◊î◊ó◊©◊ë◊ï◊ü ◊©◊ú◊ô</h3>
                        <div class="flex items-center gap-3 mb-4">
                            <div style="width:40px;height:40px;border-radius:50%;background:var(--accent-primary);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">üë§</div>
                            <div>
                                <div class="text-white text-sm opacity-60">◊û◊ó◊ï◊ë◊® ◊õ:</div>
                                <div id="settingsUserEmail" class="text-white font-semibold text-sm" dir="ltr">‚Äî</div>
                            </div>
                        </div>
                        <button onclick="handleLogout()" class="btn-logout">
                            <span>üö™</span> ◊ô◊¶◊ô◊ê◊î ◊û◊î◊ó◊©◊ë◊ï◊ü
                        </button>
                    </div>
                    <!-- Current Weight Tracker -->
                    <div class="glass-card p-6">
                        <h3 class="text-xl font-bold text-white mb-4">◊û◊¢◊ß◊ë ◊û◊©◊ß◊ú ◊†◊ï◊õ◊ó◊ô</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-white text-sm mb-2">◊û◊©◊ß◊ú ◊†◊ï◊õ◊ó◊ô (◊ß"◊í)</label>
                                <button onclick="openCurrentWeightPicker()" class="input-glass text-right w-full flex items-center justify-between">
                                    <span id="currentWeightDisplay">◊ë◊ó◊® ◊û◊©◊ß◊ú ◊†◊ï◊õ◊ó◊ô</span>
                                    <span class="opacity-50">‚ñº</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- BMR Calculator -->
                    <div class="glass-card p-6">
                        <h3 class="text-xl font-bold text-white mb-4">◊ó◊ô◊©◊ï◊ë ◊ô◊¢◊ì ◊í◊ô◊®◊¢◊ï◊ü ◊ß◊ú◊ï◊®◊ô</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-white text-sm mb-2">◊í◊ï◊ë◊î (◊°"◊û)</label>
                                <button onclick="openHeightPicker()" class="input-glass text-right w-full flex items-center justify-between">
                                    <span id="heightDisplay">◊ë◊ó◊® ◊í◊ï◊ë◊î</span>
                                    <span class="opacity-50">‚ñº</span>
                                </button>
                            </div>
                            <div>
                                <label class="block text-white text-sm mb-2">◊û◊©◊ß◊ú (◊ß"◊í)</label>
                                <button onclick="openWeightPicker()" class="input-glass text-right w-full flex items-center justify-between">
                                    <span id="weightDisplay">◊ë◊ó◊® ◊û◊©◊ß◊ú</span>
                                    <span class="opacity-50">‚ñº</span>
                                </button>
                            </div>
                            <div>
                                <label class="block text-white text-sm mb-2">◊í◊ô◊ú</label>
                                <button onclick="openAgePicker()" class="input-glass text-right w-full flex items-center justify-between">
                                    <span id="ageDisplay">◊ë◊ó◊® ◊í◊ô◊ú</span>
                                    <span class="opacity-50">‚ñº</span>
                                </button>
                            </div>
                            <div>
                                <label class="block text-white text-sm mb-1">◊û◊ô◊ü</label>
                                <select id="bmrGender" class="input-glass">
                                    <option value="">◊ë◊ó◊® ◊û◊ô◊ü</option>
                                    <option value="male">◊ñ◊õ◊®</option>
                                    <option value="female">◊†◊ß◊ë◊î</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-white text-sm mb-1">◊®◊û◊™ ◊§◊¢◊ô◊ú◊ï◊™</label>
                                <select id="bmrActivity" class="input-glass">
                                    <option value="1.2">◊û◊ô◊†◊ô◊û◊ú◊ô◊™ (◊ú◊ú◊ê ◊§◊¢◊ô◊ú◊ï◊™)</option>
                                    <option value="1.375">◊ß◊ú◊î (1-3 ◊§◊¢◊û◊ô◊ù ◊ë◊©◊ë◊ï◊¢)</option>
                                    <option value="1.55">◊ë◊ô◊†◊ï◊†◊ô◊™ (3-5 ◊§◊¢◊û◊ô◊ù ◊ë◊©◊ë◊ï◊¢)</option>
                                    <option value="1.725">◊í◊ë◊ï◊î◊î (6-7 ◊§◊¢◊û◊ô◊ù ◊ë◊©◊ë◊ï◊¢)</option>
                                    <option value="1.9">◊û◊ê◊ï◊ì ◊í◊ë◊ï◊î◊î (◊§◊¢◊ô◊ú◊ï◊™ ◊ô◊ï◊û◊ô◊™ ◊õ◊§◊ï◊ú◊î)</option>
                                </select>
                            </div>
                            <button onclick="calculateBMR()" class="btn-primary w-full">◊ó◊©◊ë</button>
                            <div id="bmrResult" class="text-white text-center font-bold text-xl mt-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="fixed bottom-0 right-0 left-0 max-w-md mx-auto" style="padding-bottom: env(safe-area-inset-bottom);">
            <div class="glass-card mx-4 mb-4 p-3">
                <div class="flex justify-around items-center">
                    <button onclick="showScreen('dashboard')" class="nav-item flex flex-col items-center gap-1 p-3 rounded-xl" id="nav-dashboard">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span class="text-xs text-white">◊ì◊©◊ë◊ï◊®◊ì</span>
                    </button>

                    <button onclick="showScreen('daily')" class="nav-item flex flex-col items-center gap-1 p-3 rounded-xl" id="nav-daily">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <span class="text-xs text-white">◊ô◊ï◊û◊ô</span>
                    </button>

                    <button onclick="showScreen('home')" class="nav-item active flex flex-col items-center gap-1 p-3 rounded-xl" id="nav-home">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        <span class="text-xs text-white">◊ë◊ô◊™</span>
                    </button>

                    <button onclick="showScreen('meals')" class="nav-item flex flex-col items-center gap-1 p-3 rounded-xl" id="nav-meals">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <!-- Fork on left -->
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5M6 4v5M8 4v5M6 9v11"/>
                            <!-- Plate in center -->
                            <circle cx="14" cy="12" r="6"/>
                            <circle cx="14" cy="12" r="3.5"/>
                            <!-- Knife on right -->
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20 4v16M20 4c1 0 1.5 0.5 1.5 2v4c0 1.5-0.5 2-1.5 2"/>
                        </svg>
                        <span class="text-xs text-white">◊û◊†◊ï◊™</span>
                    </button>

                    <button onclick="showScreen('ai')" class="nav-item flex flex-col items-center gap-1 p-3 rounded-xl" id="nav-ai">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span class="text-xs text-white">AI</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Manual Meal Modal -->
    <div id="modalAddManual" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="glass-card p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-white mb-4">◊î◊ï◊°◊£ ◊û◊†◊î ◊ó◊ì◊©◊î</h3>
            <div class="space-y-3">
                <input type="text" id="manualMealName" class="input-glass" placeholder="◊©◊ù ◊î◊û◊†◊î">
                <input type="number" id="manualMealCalories" class="input-glass" placeholder="◊ß◊ú◊ï◊®◊ô◊ï◊™">
                <div class="flex gap-3">
                    <button onclick="addManualMeal()" class="btn-primary flex-1">◊î◊ï◊°◊£</button>
                    <button onclick="closeModal('modalAddManual')" class="btn-secondary flex-1">◊ë◊ô◊ò◊ï◊ú</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add from Saved Meals Modal -->
    <div id="modalAddFromSaved" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="glass-card p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-white mb-4">◊ë◊ó◊® ◊û◊†◊î</h3>
            <div id="savedMealsSelect" class="space-y-2 mb-4">
                <!-- Will be populated -->
            </div>
            <button onclick="closeModal('modalAddFromSaved')" class="btn-secondary w-full">◊°◊í◊ï◊®</button>
        </div>
    </div>

    <!-- Add Saved Meal Modal -->
    <div id="modalAddMeal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="glass-card p-6 max-w-md w-full">
            <h3 class="text-2xl font-bold text-white mb-4">◊û◊†◊î ◊ß◊ë◊ï◊¢◊î ◊ó◊ì◊©◊î</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-sm text-white opacity-70 mb-1 block">◊©◊ù ◊î◊û◊†◊î</label>
                    <input type="text" id="newMealName" class="input-glass" placeholder="◊©◊ù ◊î◊û◊†◊î">
                </div>
                <div>
                    <label class="text-sm text-white opacity-70 mb-1 block">◊û◊©◊ß◊ú (◊í◊®◊ù)</label>
                    <input type="number" id="newMealWeight" class="input-glass" placeholder="◊û◊©◊ß◊ú (◊í◊®◊ù)">
                </div>
                <div>
                    <label class="text-sm text-white opacity-70 mb-1 block">◊ß◊ú◊ï◊®◊ô◊ï◊™</label>
                    <input type="number" id="newMealCalories" class="input-glass" placeholder="◊ß◊ú◊ï◊®◊ô◊ï◊™">
                </div>
                <div>
                    <label class="text-sm text-white opacity-70 mb-1 block">◊ë◊ó◊® ◊ê◊ô◊ô◊ß◊ï◊ü</label>
                    <div class="icon-dropdown" id="iconDropdown">
                        <button type="button" class="icon-dropdown-trigger input-glass" onclick="toggleIconDropdown('iconDropdown')">
                            <span class="icon-dropdown-selected" id="iconDropdownSelected">üçé</span>
                            <span class="icon-dropdown-arrow">‚ñº</span>
                        </button>
                        <ul class="icon-dropdown-menu hidden" id="iconDropdownMenu">
                            <!-- Populated by JS -->
                        </ul>
                        <input type="hidden" id="iconSelector" value="üçé">
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="saveMeal()" class="btn-primary flex-1">◊©◊û◊ï◊®</button>
                    <button onclick="closeModal('modalAddMeal')" class="btn-secondary flex-1">◊ë◊ô◊ò◊ï◊ú</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Saved Meal Modal -->
    <div id="modalEditMeal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="glass-card p-6 max-w-md w-full">
            <h3 class="text-2xl font-bold text-white mb-4">◊¢◊®◊ï◊ö ◊û◊†◊î</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-sm text-white opacity-70 mb-1 block">◊©◊ù ◊î◊û◊†◊î</label>
                    <input type="text" id="editMealName" class="input-glass" placeholder="◊©◊ù ◊î◊û◊†◊î">
                </div>
                <div>
                    <label class="text-sm text-white opacity-70 mb-1 block">◊û◊©◊ß◊ú (◊í◊®◊ù)</label>
                    <input type="number" id="editMealWeight" class="input-glass" placeholder="◊û◊©◊ß◊ú (◊í◊®◊ù)">
                </div>
                <div>
                    <label class="text-sm text-white opacity-70 mb-1 block">◊ß◊ú◊ï◊®◊ô◊ï◊™</label>
                    <input type="number" id="editMealCalories" class="input-glass" placeholder="◊ß◊ú◊ï◊®◊ô◊ï◊™">
                </div>
                <div>
                    <label class="text-sm text-white opacity-70 mb-1 block">◊ë◊ó◊® ◊ê◊ô◊ô◊ß◊ï◊ü</label>
                    <div class="icon-dropdown" id="editIconDropdown">
                        <button type="button" class="icon-dropdown-trigger input-glass" onclick="toggleIconDropdown('editIconDropdown')">
                            <span class="icon-dropdown-selected" id="editIconDropdownSelected">üçé</span>
                            <span class="icon-dropdown-arrow">‚ñº</span>
                        </button>
                        <ul class="icon-dropdown-menu hidden" id="editIconDropdownMenu">
                            <!-- Populated by JS -->
                        </ul>
                        <input type="hidden" id="editIconSelector" value="üçé">
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="updateMeal()" class="btn-primary flex-1">◊¢◊ì◊õ◊ü</button>
                    <button onclick="closeModal('modalEditMeal')" class="btn-secondary flex-1">◊ë◊ô◊ò◊ï◊ú</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Steps Picker Modal -->
    <div id="modalStepsPicker" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="glass-card p-6 max-w-sm w-full">
            <h3 class="text-2xl font-bold text-white mb-6 text-center">◊î◊ï◊°◊£ ◊¶◊¢◊ì◊ô◊ù</h3>
            
            <div class="relative h-64 overflow-hidden mb-6">
                <!-- Gradient overlays for depth effect -->
                <div class="absolute top-0 left-0 right-0 h-20 bg-gradient-to-b from-[#0f2027] to-transparent z-10 pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 right-0 h-20 bg-gradient-to-t from-[#0f2027] to-transparent z-10 pointer-events-none"></div>
                
                <!-- Selection indicator -->
                <div class="absolute left-0 right-0 top-1/2 transform -translate-y-1/2 h-16 border-y-2 border-cyan-400 bg-cyan-400/10 pointer-events-none z-10"></div>
                
                <!-- Scrollable numbers -->
                <div id="stepsWheel" class="h-full overflow-y-scroll scrollbar-hide relative" style="scroll-snap-type: y mandatory;">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="confirmSteps()" class="btn-primary flex-1">◊ê◊ô◊©◊ï◊®</button>
                <button onclick="closeModal('modalStepsPicker')" class="btn-secondary flex-1">◊ë◊ô◊ò◊ï◊ú</button>
            </div>
        </div>
    </div>

    <!-- Height Picker Modal -->
    <div id="modalHeightPicker" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="glass-card p-6 max-w-sm w-full">
            <h3 class="text-2xl font-bold text-white mb-6 text-center">◊ë◊ó◊® ◊í◊ï◊ë◊î (◊°"◊û)</h3>
            
            <div class="relative h-64 overflow-hidden mb-6">
                <div class="absolute top-0 left-0 right-0 h-20 bg-gradient-to-b from-[#0f2027] to-transparent z-10 pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 right-0 h-20 bg-gradient-to-t from-[#0f2027] to-transparent z-10 pointer-events-none"></div>
                <div class="absolute left-0 right-0 top-1/2 transform -translate-y-1/2 h-16 border-y-2 border-cyan-400 bg-cyan-400/10 pointer-events-none z-10"></div>
                
                <div id="heightWheel" class="h-full overflow-y-scroll scrollbar-hide relative" style="scroll-snap-type: y mandatory;">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="confirmHeight()" class="btn-primary flex-1">◊ê◊ô◊©◊ï◊®</button>
                <button onclick="closeModal('modalHeightPicker')" class="btn-secondary flex-1">◊ë◊ô◊ò◊ï◊ú</button>
            </div>
        </div>
    </div>

    <!-- Weight Picker Modal -->
    <div id="modalWeightPicker" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="glass-card p-6 max-w-sm w-full">
            <h3 class="text-2xl font-bold text-white mb-6 text-center">◊ë◊ó◊® ◊û◊©◊ß◊ú (◊ß"◊í)</h3>
            
            <div class="relative h-64 overflow-hidden mb-6">
                <div class="absolute top-0 left-0 right-0 h-20 bg-gradient-to-b from-[#0f2027] to-transparent z-10 pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 right-0 h-20 bg-gradient-to-t from-[#0f2027] to-transparent z-10 pointer-events-none"></div>
                <div class="absolute left-0 right-0 top-1/2 transform -translate-y-1/2 h-16 border-y-2 border-cyan-400 bg-cyan-400/10 pointer-events-none z-10"></div>
                
                <div id="weightWheel" class="h-full overflow-y-scroll scrollbar-hide relative" style="scroll-snap-type: y mandatory;">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="confirmWeight()" class="btn-primary flex-1">◊ê◊ô◊©◊ï◊®</button>
                <button onclick="closeModal('modalWeightPicker')" class="btn-secondary flex-1">◊ë◊ô◊ò◊ï◊ú</button>
            </div>
        </div>
    </div>

    <!-- Age Picker Modal -->
    <div id="modalAgePicker" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="glass-card p-6 max-w-sm w-full">
            <h3 class="text-2xl font-bold text-white mb-6 text-center">◊ë◊ó◊® ◊í◊ô◊ú</h3>
            
            <div class="relative h-64 overflow-hidden mb-6">
                <div class="absolute top-0 left-0 right-0 h-20 bg-gradient-to-b from-[#0f2027] to-transparent z-10 pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 right-0 h-20 bg-gradient-to-t from-[#0f2027] to-transparent z-10 pointer-events-none"></div>
                <div class="absolute left-0 right-0 top-1/2 transform -translate-y-1/2 h-16 border-y-2 border-cyan-400 bg-cyan-400/10 pointer-events-none z-10"></div>
                
                <div id="ageWheel" class="h-full overflow-y-scroll scrollbar-hide relative" style="scroll-snap-type: y mandatory;">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="confirmAge()" class="btn-primary flex-1">◊ê◊ô◊©◊ï◊®</button>
                <button onclick="closeModal('modalAgePicker')" class="btn-secondary flex-1">◊ë◊ô◊ò◊ï◊ú</button>
            </div>
        </div>
    </div>

    <!-- Quantity Picker Modal -->
    <div id="modalQuantityPicker" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="glass-card p-6 max-w-sm w-full">
            <h3 class="text-2xl font-bold text-white mb-6 text-center">◊¢◊ì◊õ◊ü ◊õ◊û◊ï◊™</h3>
            
            <!-- Plus/Minus Controls -->
            <div class="flex items-center justify-center gap-4 mb-6">
                <button onclick="decreaseQuantity()" class="w-14 h-14 bg-white/10 hover:bg-white/20 rounded-xl flex items-center justify-center text-white text-2xl font-bold transition-all active:scale-95">
                    ‚àí
                </button>
                
                <div class="text-center">
                    <div class="text-4xl font-bold text-white" id="quantityDisplay">1.0</div>
                    <div class="text-white opacity-60 text-sm mt-1">◊õ◊û◊ï◊™</div>
                </div>
                
                <button onclick="increaseQuantity()" class="w-14 h-14 bg-white/10 hover:bg-white/20 rounded-xl flex items-center justify-center text-white text-2xl font-bold transition-all active:scale-95">
                    +
                </button>
            </div>

            <div class="flex gap-3">
                <button onclick="confirmQuantity()" class="btn-primary flex-1">◊ê◊ô◊©◊ï◊®</button>
                <button onclick="closeModal('modalQuantityPicker')" class="btn-secondary flex-1">◊ë◊ô◊ò◊ï◊ú</button>
            </div>
        </div>
    </div>

    <!-- Current Weight Picker Modal -->
    <div id="modalCurrentWeightPicker" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="glass-card p-6 max-w-sm w-full">
            <h3 class="text-2xl font-bold text-white mb-6 text-center">◊ë◊ó◊® ◊û◊©◊ß◊ú ◊†◊ï◊õ◊ó◊ô (◊ß"◊í)</h3>
            
            <div class="relative h-64 overflow-hidden mb-6">
                <div class="absolute top-0 left-0 right-0 h-20 bg-gradient-to-b from-[#0f2027] to-transparent z-10 pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 right-0 h-20 bg-gradient-to-t from-[#0f2027] to-transparent z-10 pointer-events-none"></div>
                <div class="absolute left-0 right-0 top-1/2 transform -translate-y-1/2 h-16 border-y-2 border-cyan-400 bg-cyan-400/10 pointer-events-none z-10"></div>
                
                <div id="currentWeightWheel" class="h-full overflow-y-scroll scrollbar-hide relative" style="scroll-snap-type: y mandatory;">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="confirmCurrentWeight()" class="btn-primary flex-1">◊ê◊ô◊©◊ï◊®</button>
                <button onclick="closeModal('modalCurrentWeightPicker')" class="btn-secondary flex-1">◊ë◊ô◊ò◊ï◊ú</button>
            </div>
        </div>
    </div>

    <style>
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .step-option {
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            scroll-snap-align: center;
        }
        
        .step-option.selected {
            color: rgba(255, 255, 255, 1);
            font-size: 40px;
        }
    </style>

    <script>
        console.log("üî• CalorieTrack IL - Supabase Version 3.0 - Multi-User Auth");
        // ========================
        // SUPABASE CONFIGURATION
        // ========================
        const SUPABASE_URL = 'https://hxzcuhrrfgtyencumilp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4emN1aHJyZmd0eWVuY3VtaWxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MDA0MTYsImV4cCI6MjA4NjQ3NjQxNn0.fKGBmunJi4Y-pyBLmuMLj4QWyvE6Xyu9tlWzARsiYZQ';
        
        // Initialize Supabase client
        let supabaseClient = null;
        if (typeof window.supabase !== 'undefined' && 
            SUPABASE_URL !== 'YOUR_SUPABASE_URL_HERE' && 
            SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY_HERE') {
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úÖ Supabase connected successfully');
            } catch (error) {
                console.warn('‚ö†Ô∏è Supabase initialization failed:', error);
            }
        }

        // Currently authenticated user (replaces getUserId())
        let currentUser = null;
        function getUserId() {
            return currentUser?.id || null;
        }
        
        // ========================
        // GEMINI AI CONFIGURATION
        // ========================
        // API Key removed - now using secure Supabase Edge Function
        
        // Store last AI analysis result
        let lastAIResult = null;

        // Food icons
        const foodIcons = [
            // ◊§◊ô◊®◊ï◊™ ◊ï◊ô◊®◊ß◊ï◊™
            'üçé', 'üçè', 'üçå', 'üçê', 'üçä', 'üçã', 'üçì', 'üçá', 'üçâ', 'ü•ë', 'ü•¶', 'ü•ï', 'ü•í', 'üçÖ', 'üçÑ',
            // ◊ó◊ú◊ë◊ï◊†◊ô◊ù ◊ï◊û◊†◊ï◊™ ◊¢◊ô◊ß◊®◊ô◊ï◊™
            'üç≥', 'üçó', 'ü•©', 'üêü', 'üç§', 'üç£', 'üç±', 'üç≤', 'ü•ò', 'üçù', 'üçú', 'üçõ', 'üçö', 'ü•ü',
            // ◊ú◊ó◊û◊ô◊ù, ◊ì◊í◊†◊ô◊ù ◊ï◊û◊ê◊§◊ô◊ù
            'üçû', 'ü•ñ', 'ü•Ø', 'ü•™', 'ü•ô', 'ü•£', 'ü•ê', 'ü•®', 'üßÄ', 'üßà',
            // ◊ë◊°◊ô◊°, ◊®◊ò◊ë◊ô◊ù ◊ï◊ó◊ò◊ô◊§◊ô◊ù ◊ë◊®◊ô◊ê◊ô◊ù
            'üç∂', 'üßÇ', 'üçø', 'üç´', 'üçØ',
            // ◊©◊™◊ô◊ô◊î ◊ë◊°◊ô◊°◊ô◊™
            'üíß', '‚òï', 'üçµ'
        ];

        // App State
        let appState = {
            currentScreen: 'home',
            lastDate: null, // Track last day the app was opened
            settings: {
                dailyGoal: 2000,
                currentWeight: 70,
                height: null,
                weight: null,
                age: null
            },
            todayData: {
                calories: 0,
                steps: 0,
                water: 0,
                protein: 0,
                meals: []
            },
            savedMeals: [],
            weeklyData: {
                currentWeek: 0,
                weeks: []
            }
        };

        // Initialize
        // ========================
        // AUTH FUNCTIONS
        // ========================

        let currentAuthTab = 'login';

        function switchAuthTab(tab) {
            currentAuthTab = tab;
            document.getElementById('tabLogin').classList.toggle('active', tab === 'login');
            document.getElementById('tabSignup').classList.toggle('active', tab === 'signup');
            document.getElementById('authBtn').textContent = tab === 'login' ? '◊õ◊†◊ô◊°◊î' : '◊î◊®◊©◊û◊î';
            document.getElementById('authConfirmDiv').classList.toggle('hidden', tab === 'login');
            clearAuthError();
        }

        function showAuthError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.classList.add('visible');
        }

        function clearAuthError() {
            const el = document.getElementById('authError');
            el.textContent = '';
            el.classList.remove('visible');
        }

        function togglePwVisibility(inputId, btn) {
            const input = document.getElementById(inputId);
            const isHidden = input.type === 'password';
            input.type = isHidden ? 'text' : 'password';
            // Swap eye / eye-off icon
            btn.querySelector('svg').innerHTML = isHidden
                ? `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>`
                : `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>`;
            btn.style.color = isHidden ? 'rgba(255,255,255,0.8)' : 'rgba(255,255,255,0.45)';
        }

        function setAuthBtnLoading(loading) {
            const btn = document.getElementById('authBtn');
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = `◊û◊™◊ó◊ë◊®<span class="auth-dots"><span></span><span></span><span></span></span>`;
            } else {
                btn.disabled = false;
                btn.textContent = currentAuthTab === 'login' ? '◊õ◊†◊ô◊°◊î' : '◊î◊®◊©◊û◊î';
            }
        }

        let toastTimer = null;
        function showSuccessToast(text = '◊î◊î◊®◊©◊û◊î ◊ë◊ï◊¶◊¢◊î ◊ë◊î◊¶◊ú◊ó◊î!', sub = '◊ë◊®◊ï◊ö ◊î◊ë◊ê ◊ú-CalorieTrack IL') {
            const toast = document.getElementById('authSuccessToast');
            toast.querySelector('.toast-text').textContent = text;
            toast.querySelector('.toast-sub').textContent = sub;
            toast.classList.add('show');
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => toast.classList.remove('show'), 3500);
        }

        async function handleAuth() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            clearAuthError();

            if (!email || !password) { showAuthError('◊†◊ê ◊ú◊û◊ú◊ê ◊ê◊ô◊û◊ô◊ô◊ú ◊ï◊°◊ô◊°◊û◊î'); return; }
            if (password.length < 6) { showAuthError('◊î◊°◊ô◊°◊û◊î ◊ó◊ô◊ô◊ë◊™ ◊ú◊î◊õ◊ô◊ú ◊ú◊§◊ó◊ï◊™ 6 ◊™◊ï◊ï◊ô◊ù'); return; }

            if (currentAuthTab === 'signup') {
                const confirm = document.getElementById('authConfirm').value;
                if (password !== confirm) { showAuthError('◊î◊°◊ô◊°◊û◊ê◊ï◊™ ◊ê◊ô◊†◊ü ◊™◊ï◊ê◊û◊ï◊™'); return; }
            }

            setAuthBtnLoading(true);

            try {
                if (currentAuthTab === 'login') {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    // onAuthStateChange handles the transition
                } else {
                    const { data, error } = await supabaseClient.auth.signUp({ email, password });
                    if (error) throw error;
                    if (data.user && !data.session) {
                        // Email confirmation required
                        setAuthBtnLoading(false);
                        showAuthError('◊†◊©◊ú◊ó ◊ê◊ô◊û◊ô◊ô◊ú ◊ê◊ô◊û◊ï◊™ ‚Äî ◊ê◊†◊ê ◊ê◊û◊™ ◊ê◊™ ◊õ◊™◊ï◊ë◊™◊ö');
                        return;
                    }
                    // Signed up AND auto-confirmed ‚Üí show toast before transition
                    showSuccessToast('◊î◊î◊®◊©◊û◊î ◊ë◊ï◊¶◊¢◊î ◊ë◊î◊¶◊ú◊ó◊î!', '◊ë◊®◊ï◊ö ◊î◊ë◊ê ◊ú-CalorieTrack IL üéâ');
                    // onAuthStateChange will fire and call showApp + init
                }
            } catch (error) {
                const msg = error.message?.includes('Invalid login')    ? '◊ê◊ô◊û◊ô◊ô◊ú ◊ê◊ï ◊°◊ô◊°◊û◊î ◊©◊í◊ï◊ô◊ô◊ù' :
                            error.message?.includes('already registered') ? '◊õ◊™◊ï◊ë◊™ ◊î◊ê◊ô◊û◊ô◊ô◊ú ◊õ◊ë◊® ◊®◊©◊ï◊û◊î' :
                            error.message || '◊©◊í◊ô◊ê◊î ◊ú◊ê ◊ô◊ì◊ï◊¢◊î';
                showAuthError(msg);
                setAuthBtnLoading(false);
            }
        }

        // Allow Enter key in auth fields
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !document.getElementById('auth-screen').classList.contains('hidden')) {
                handleAuth();
            }
        });

        async function handleLogout() {
            if (!confirm('◊î◊ê◊ù ◊ê◊™◊î ◊ë◊ò◊ï◊ó ◊©◊ë◊®◊¶◊ï◊†◊ö ◊ú◊¶◊ê◊™?')) return;
            await supabaseClient.auth.signOut();
        }

        function showApp() {
            const authEl = document.getElementById('auth-screen');
            const appEl  = document.getElementById('app');
            authEl.style.display = 'none';
            authEl.classList.remove('visible');
            appEl.style.display  = 'block';
            console.log('‚úÖ showApp: auth hidden, app visible');
        }

        function showAuthScreen() {
            const authEl = document.getElementById('auth-screen');
            const appEl  = document.getElementById('app');
            appEl.style.display  = 'none';
            authEl.style.display = 'flex';
            authEl.classList.add('visible');
            console.log('‚úÖ showAuthScreen: app hidden, auth visible');
            // Reset app state for next login
            appState.todayData   = { calories: 0, steps: 0, water: 0, protein: 0, meals: [] };
            appState.savedMeals  = [];
        }

        async function init() {
            await loadState();
            await checkDateChange();
            initCharts();
            renderSavedMeals();
            renderIconSelector();
            renderTodayMeals();
            updateHomeScreen();
            syncTodayToWeekly();
            updateWeeklyChart();
            // Show user email in settings
            const emailEl = document.getElementById('settingsUserEmail');
            if (emailEl && currentUser) emailEl.textContent = currentUser.email;
        }

        // ========================
        // SUPABASE DATA FUNCTIONS
        // ========================
        
        // Load all data from Supabase
        async function loadState() {
            const userId = getUserId();
            if (!userId) { console.warn('loadState: no user'); return; }
            try {
                // Load profile (settings)
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('user_id', getUserId())
                    .single();
                
                if (profile) {
                    appState.settings = {
                        dailyGoal: profile.daily_calorie_goal || 2000,
                        currentWeight: profile.current_weight || 70,
                        height: profile.height,
                        weight: profile.weight,
                        age: profile.age
                    };
                } else {
                    // Create default profile if doesn't exist
                    await createDefaultProfile();
                }

                // Load saved meals (ordered by position)
                const { data: meals, error: mealsError } = await supabaseClient
                    .from('saved_meals')
                    .select('*')
                    .eq('user_id', getUserId())
                    .order('position', { ascending: true });
                
                if (meals) {
                    appState.savedMeals = meals.map(m => ({
                        id: m.id,
                        name: m.name,
                        weight: m.weight,
                        calories: m.calories,
                        protein: m.protein,
                        icon: m.icon
                    }));
                }

                // Load today's log
                const today = new Date().toISOString().split('T')[0];
                const { data: todayLog, error: logError } = await supabaseClient
                    .from('daily_logs')
                    .select('*')
                    .eq('user_id', getUserId())
                    .eq('date', today)
                    .single();
                
                if (todayLog) {
                    appState.todayData = {
                        calories: todayLog.total_calories || 0,
                        steps: todayLog.steps || 0,
                        water: todayLog.water || 0,
                        protein: todayLog.protein || 0,
                        meals: todayLog.meals || []
                    };
                    appState.lastDate = new Date(todayLog.date).toDateString();
                } else {
                    // Create today's log
                    await createTodayLog();
                    appState.lastDate = new Date().toDateString();
                }

                // Load weekly data (last 52 weeks)
                await loadWeeklyData();
                
                // Data migration: Fix week structure if needed
                fixWeekDataStructure();
                
            } catch (error) {
                console.error('Error loading data from Supabase:', error);
                // Fallback to localStorage if Supabase fails
                loadStateFromLocalStorage();
            }
        }

        // Create default profile
        async function createDefaultProfile() {
            const { data, error } = await supabaseClient
                .from('profiles')
                .insert([{
                    user_id: getUserId(),
                    daily_calorie_goal: 2000,
                    current_weight: 70,
                    height: null,
                    weight: null,
                    age: null
                }])
                .select()
                .single();
            
            if (error) console.error('Error creating profile:', error);
        }

        // Create today's log
        async function createTodayLog() {
            const today = new Date().toISOString().split('T')[0];
            const { data, error } = await supabaseClient
                .from('daily_logs')
                .insert([{
                    user_id: getUserId(),
                    date: today,
                    total_calories: 0,
                    protein: 0,
                    steps: 0,
                    water: 0,
                    meals: []
                }])
                .select()
                .single();
            
            if (error) console.error('Error creating today log:', error);
        }

        // Load weekly data from daily logs
        async function loadWeeklyData() {
            // Calculate date range for last 52 weeks
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - (52 * 7));
            
            const { data: logs, error } = await supabaseClient
                .from('daily_logs')
                .select('*')
                .eq('user_id', getUserId())
                .gte('date', startDate.toISOString().split('T')[0])
                .order('date', { ascending: true });
            
            if (logs) {
                // Initialize empty weeks structure
                appState.weeklyData.weeks = Array(52).fill(null).map(() => 
                    Array(7).fill(null).map(() => ({
                        calories: 0,
                        protein: 0,
                        meals: [],
                        date: new Date().toISOString()
                    }))
                );

                // Populate with actual data
                logs.forEach(log => {
                    const logDate = new Date(log.date);
                    const dayOfWeek = logDate.getDay(); // 0 = Sunday
                    const weeksDiff = Math.floor((today - logDate) / (7 * 24 * 60 * 60 * 1000));
                    
                    if (weeksDiff >= 0 && weeksDiff < 52) {
                        appState.weeklyData.weeks[weeksDiff][dayOfWeek] = {
                            calories: log.total_calories || 0,
                            protein: log.protein || 0,
                            meals: log.meals || [],
                            date: log.date,
                            tdee: log.tdee || 2000
                        };
                    }
                });
            } else {
                initializeWeeklyData();
            }
        }

        // Save profile to Supabase
        async function saveProfile() {
            if (!supabaseClient) {
                console.log('‚è≠Ô∏è Skipping saveProfile (no Supabase)');
                return;
            }
            
            try {
                console.log('üë§ saveProfile called');
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .upsert({
                        user_id: getUserId(),
                        daily_calorie_goal: appState.settings.dailyGoal,
                        current_weight: appState.settings.currentWeight,
                        height: appState.settings.height,
                        weight: appState.settings.weight,
                        age: appState.settings.age,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });
                
                if (error) throw error;
                console.log('‚úÖ Profile saved');
            } catch (error) {
                console.error('‚ùå Error saving profile:', error);
            }
        }

        // Save today's data to Supabase
        async function saveTodayData() {
            console.log('üíæ saveTodayData called');
            console.log('   supabaseClient exists:', !!supabaseClient);
            console.log('   todayData:', appState.todayData);
            
            if (!supabaseClient) {
                console.error('‚ùå No Supabase client - cannot save!');
                return;
            }
            
            try {
                const today = new Date().toISOString().split('T')[0];
                console.log('   Saving for date:', today);
                
                const dataToSave = {
                    user_id: getUserId(),
                    date: today,
                    total_calories: appState.todayData.calories,
                    protein: appState.todayData.protein,
                    steps: appState.todayData.steps,
                    water: appState.todayData.water,
                    meals: appState.todayData.meals,
                    tdee: appState.settings.dailyGoal || 2000,
                    updated_at: new Date().toISOString()
                };
                
                console.log('   Data to save:', dataToSave);
                
                // Use upsert to insert or update
                const { data, error } = await supabaseClient
                    .from('daily_logs')
                    .upsert(dataToSave, {
                        onConflict: 'user_id,date'
                    });
                
                if (error) {
                    console.error('‚ùå Supabase error:', error);
                    throw error;
                }
                console.log('‚úÖ Today data saved successfully to Supabase');
                console.log('   Response:', data);
            } catch (error) {
                console.error('‚ùå Error saving today data:', error);
            }
        }

        // Save saved meals to Supabase
        async function saveSavedMeals() {
            if (!supabaseClient) {
                console.log('‚è≠Ô∏è Skipping saveSavedMeals (no Supabase)');
                return;
            }
            
            try {
                console.log('üç± saveSavedMeals called');
                // Delete all existing meals for this user
                await supabaseClient
                    .from('saved_meals')
                    .delete()
                    .eq('user_id', getUserId());
                
                // Insert all meals with updated positions
                const mealsToInsert = appState.savedMeals.map((meal, index) => ({
                    user_id: getUserId(),
                    name: meal.name,
                    weight: meal.weight,
                    calories: meal.calories,
                    protein: meal.protein || 0,
                    icon: meal.icon,
                    position: index
                }));
                
                if (mealsToInsert.length > 0) {
                    const { data, error } = await supabaseClient
                        .from('saved_meals')
                        .insert(mealsToInsert);
                    
                    if (error) throw error;
                }
                console.log('‚úÖ Saved meals saved');
            } catch (error) {
                console.error('‚ùå Error saving meals:', error);
            }
        }

        // Unified save function (replaces saveState)
        async function saveState() {
            console.log('üì¶ saveState called');
            try {
                await Promise.all([
                    saveProfile(),
                    saveTodayData(),
                    saveSavedMeals()
                ]);
                console.log('üì¶ saveState completed successfully');
            } catch (error) {
                console.error('‚ùå saveState error:', error);
            }
        }

        // Fallback to localStorage (for offline support)
        function loadStateFromLocalStorage() {
            const saved = localStorage.getItem('calorieTrackIL');
            if (saved) {
                appState = JSON.parse(saved);
                if (!appState.todayData.meals) {
                    appState.todayData.meals = [];
                }
                fixWeekDataStructure();
            } else {
                initializeWeeklyData();
            }
        }

        // Fix week data structure for users who have old data
        function fixWeekDataStructure() {
            const today = new Date();
            const todayDayOfWeek = today.getDay(); // 0 = Sunday

            // Fix negative currentWeek from old version
            if (appState.weeklyData.currentWeek < 0) {
                appState.weeklyData.currentWeek = 0;
            }

            if (!appState.weeklyData.weeks || appState.weeklyData.weeks.length === 0) {
                initializeWeeklyData();
                return;
            }

            // Calculate this week's Sunday (start of current calendar week)
            const thisWeekSunday = new Date(today);
            thisWeekSunday.setDate(today.getDate() - todayDayOfWeek);
            thisWeekSunday.setHours(0, 0, 0, 0);

            // Scan weeks[0] and zero out any day that belongs to a PREVIOUS calendar week.
            // A day slot belongs to a previous week when its stored date is before thisWeekSunday.
            const currentWeek = appState.weeklyData.weeks[0];
            if (currentWeek) {
                let fixed = false;
                for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
                    const slot = currentWeek[dayIdx];
                    if (!slot || !slot.date || slot.calories === 0) continue;

                    const slotDate = new Date(slot.date);
                    slotDate.setHours(0, 0, 0, 0);

                    // If the slot's date is before this week's Sunday ‚Üí it's stale ghost data
                    if (slotDate < thisWeekSunday) {
                        console.log(`üîß Ghost data detected in weeks[0][${dayIdx}] (date: ${slotDate.toDateString()}, before ${thisWeekSunday.toDateString()}). Clearing.`);

                        // Try to save to the correct past-week slot in weeks[1]
                        if (!appState.weeklyData.weeks[1]) {
                            appState.weeklyData.weeks[1] = Array(7).fill(null).map(() => ({
                                calories: 0, protein: 0, meals: [], date: new Date().toISOString(), tdee: 2000
                            }));
                        }
                        // Only overwrite if destination is empty (don't clobber real data)
                        if (!appState.weeklyData.weeks[1][dayIdx] || appState.weeklyData.weeks[1][dayIdx].calories === 0) {
                            appState.weeklyData.weeks[1][dayIdx] = { ...slot };
                        }

                        // Clear the ghost slot from current week
                        // Use current TDEE setting instead of hardcoded 2000
                        const currentTdee = appState.settings.dailyGoal || 2000;
                        currentWeek[dayIdx] = {
                            calories: 0, protein: 0, meals: [], date: today.toISOString(), tdee: currentTdee
                        };
                        fixed = true;
                    }
                }

                if (fixed) {
                    console.log('‚úÖ Ghost data cleared from current week.');
                    saveState();
                }
            }
        }

        // Check if date changed and reset daily data if needed
        async function checkDateChange() {
            const today = new Date();
            const todayString = today.toDateString(); // e.g., "Sun Feb 08 2026"
            const todayDayOfWeek = today.getDay(); // 0 = Sunday
            
            // If lastDate doesn't exist, set it to today
            if (!appState.lastDate) {
                appState.lastDate = todayString;
                await saveState();
                return;
            }
            
            // Check if date changed
            if (appState.lastDate !== todayString) {
                console.log('üìÖ Date changed! Processing week transition...');
                
                // Parse the last date to check if we crossed into a new week
                const lastDate = new Date(appState.lastDate);
                const lastDayOfWeek = lastDate.getDay();
                
                // CRITICAL: Check if we've moved to a new week (today is Sunday and yesterday was NOT Sunday)
                // We must shift BEFORE syncing yesterday's data
                if (todayDayOfWeek === 0 && lastDayOfWeek !== 0) {
                    console.log('üîÑ New week detected! Shifting weeks array...');
                    
                    // Create a new empty week for the current week
                    const newWeek = Array(7).fill(null).map(() => ({
                        calories: 0,
                        protein: 0,
                        meals: [],
                        date: new Date().toISOString()
                    }));
                    
                    // Unshift: add new week to the beginning, making old weeks[0] become weeks[1]
                    appState.weeklyData.weeks.unshift(newWeek);
                    
                    // Pop: remove the last week to keep array size at 52
                    appState.weeklyData.weeks.pop();
                    
                    console.log('‚úÖ Weeks shifted. Old current week is now weeks[1].');
                }
                
                // Now sync yesterday's data to the correct week
                // If we just shifted, Saturday data goes to weeks[1][6]
                // If we didn't shift (Mon-Sat), data goes to weeks[0][yesterday]
                syncYesterdayToWeekly(lastDate, lastDayOfWeek);
                
                // Get yesterday's stats for the notification
                const yesterdayCalories = appState.todayData.calories;
                
                // Reset daily counters
                appState.todayData = {
                    calories: 0,
                    steps: 0,
                    water: 0,
                    protein: 0,
                    meals: []
                };
                
                // Create new daily log in Supabase for today
                await createTodayLog();
                
                // Update lastDate to today
                appState.lastDate = todayString;
                
                // Save the updated state
                await saveState();
                
                console.log('‚úÖ Daily data reset complete!');
                
                // Show notification to user
                setTimeout(() => {
                    showNotification(`üåÖ ◊ô◊ï◊ù ◊ó◊ì◊©! ◊ê◊™◊û◊ï◊ú: ${yesterdayCalories} ◊ß◊ú◊ï◊®◊ô◊ï◊™`);
                }, 500);
            }
        }

        // Sync yesterday's data to the correct week slot
        function syncYesterdayToWeekly(yesterdayDate, yesterdayDayOfWeek) {
            const today = new Date();
            const todayDayOfWeek = today.getDay();
            
            // Make sure weekly data exists
            if (!appState.weeklyData.weeks || appState.weeklyData.weeks.length === 0) {
                initializeWeeklyData();
            }
            
            // Determine which week index to save to
            let targetWeekIndex = 0; // Default to current week
            
            // If today is Sunday and yesterday was Saturday, we already shifted
            // So yesterday's data belongs to weeks[1] (the previous week)
            if (todayDayOfWeek === 0 && yesterdayDayOfWeek === 6) {
                targetWeekIndex = 1; // Last week (we just shifted)
                console.log(`üíæ Syncing Saturday data to weeks[1][6] (last week)`);
            } else {
                // Normal case: same week, just yesterday
                targetWeekIndex = 0; // Current week
                console.log(`üíæ Syncing yesterday's data to weeks[0][${yesterdayDayOfWeek}] (current week)`);
            }
            
            // Make sure the target week exists
            if (!appState.weeklyData.weeks[targetWeekIndex]) {
                console.error(`Week index ${targetWeekIndex} doesn't exist!`);
                return;
            }
            
            // Save yesterday's full data to the correct slot (including meals)
            appState.weeklyData.weeks[targetWeekIndex][yesterdayDayOfWeek] = {
                calories: appState.todayData.calories,
                protein: appState.todayData.protein,
                meals: JSON.parse(JSON.stringify(appState.todayData.meals)), // Deep copy
                date: yesterdayDate.toISOString()
            };
            
            console.log(`‚úÖ Data saved: ${appState.todayData.calories} calories to weeks[${targetWeekIndex}][${yesterdayDayOfWeek}]`);
        }

        // Remove the old shiftWeeklyData function - we do it inline now

        // Initialize weekly data structure
        function initializeWeeklyData() {
            appState.weeklyData.weeks = Array(52).fill(null).map(() => 
                Array(7).fill(null).map(() => ({
                    calories: 0,
                    protein: 0,
                    meals: [],
                    date: new Date().toISOString(),
                    tdee: 2000
                }))
            );
        }

        // Sync today's data to weekly dashboard (for real-time updates during the day)
        function syncTodayToWeekly() {
            const today = new Date();
            const todayDayOfWeek = today.getDay(); // 0 = Sunday, 6 = Saturday
            const weekIndex = 0; // Always sync current day to current week (weeks[0])
            
            // Make sure weekly data exists
            if (!appState.weeklyData.weeks || !appState.weeklyData.weeks[weekIndex]) {
                initializeWeeklyData();
            }
            
            // Sync today's full data to the current week (including meals array)
            appState.weeklyData.weeks[weekIndex][todayDayOfWeek] = {
                calories: appState.todayData.calories,
                protein: appState.todayData.protein,
                meals: JSON.parse(JSON.stringify(appState.todayData.meals)), // Deep copy
                date: today.toISOString()
            };
            
            // Always update the chart - SVG chart is always available
            updateWeeklyChart();
        }

        // Save state
        // Old saveState removed - using async version above
        
        // Charts
        // Charts are now SVG-based, no Chart.js variables needed

        function initCharts() {
            // Both Donut and Weekly charts are now SVG-based
            // No Chart.js initialization needed
            
            // Donut Chart - SVG-based, updated via updateCalorieDisplay()
            // Weekly Chart - SVG-based, updated via updateWeeklyChart()
            
            console.log('üìä Charts initialized (SVG-based)');
        }

        // Navigation
        function showScreen(screen) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // Show selected screen
            document.getElementById(`screen-${screen}`).classList.remove('hidden');
            document.getElementById(`nav-${screen}`).classList.add('active');
            
            appState.currentScreen = screen;
        }

        function showSettings() {
            showScreen('settings');
            
            // Update display texts - only show if user has selected values
            if (appState.settings.height) {
                document.getElementById('heightDisplay').textContent = appState.settings.height + ' ◊°"◊û';
            }
            
            if (appState.settings.weight) {
                const displayValue = appState.settings.weight % 1 === 0 ? appState.settings.weight : appState.settings.weight.toFixed(1);
                document.getElementById('weightDisplay').textContent = displayValue + ' ◊ß"◊í';
            }
            
            if (appState.settings.age) {
                document.getElementById('ageDisplay').textContent = appState.settings.age + ' ◊©◊†◊ô◊ù';
            }
        }

        // Water Glasses
        // Steps
        let selectedSteps = 0;

        function showStepsPicker() {
            const wheel = document.getElementById('stepsWheel');
            wheel.innerHTML = '';
            
            // Create padding elements for better scrolling
            const padding = document.createElement('div');
            padding.style.height = '128px';
            wheel.appendChild(padding.cloneNode());
            
            // Create options from 0 to 20000 in steps of 100
            for (let i = 0; i <= 20000; i += 100) {
                const option = document.createElement('div');
                option.className = 'step-option';
                option.textContent = i.toLocaleString();
                option.dataset.value = i;
                wheel.appendChild(option);
            }
            
            wheel.appendChild(padding.cloneNode());
            
            // Scroll to middle (around 5000)
            setTimeout(() => {
                const targetIndex = 50; // 5000 steps
                const targetOption = wheel.children[targetIndex + 1];
                if (targetOption) {
                    targetOption.scrollIntoView({ block: 'center' });
                }
                updateSelectedStep();
            }, 50);
            
            // Add scroll listener
            wheel.addEventListener('scroll', updateSelectedStep);
            
            document.getElementById('modalStepsPicker').classList.remove('hidden');
        }

        function updateSelectedStep() {
            const wheel = document.getElementById('stepsWheel');
            const wheelRect = wheel.getBoundingClientRect();
            const centerY = wheelRect.top + wheelRect.height / 2;
            
            let closestOption = null;
            let closestDistance = Infinity;
            
            const options = wheel.querySelectorAll('.step-option');
            options.forEach(option => {
                const rect = option.getBoundingClientRect();
                const optionCenterY = rect.top + rect.height / 2;
                const distance = Math.abs(centerY - optionCenterY);
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestOption = option;
                }
                
                option.classList.remove('selected');
            });
            
            if (closestOption) {
                closestOption.classList.add('selected');
                selectedSteps = parseInt(closestOption.dataset.value);
            }
        }

        function confirmSteps() {
            if (selectedSteps > 0) {
                appState.todayData.steps += selectedSteps;
                updateHomeScreen();
                saveState();
                showNotification(`◊†◊ï◊°◊§◊ï ${selectedSteps.toLocaleString()} ◊¶◊¢◊ì◊ô◊ù! ‚úì`);
            }
            closeModal('modalStepsPicker');
        }

        // Update Home Screen
        function updateHomeScreen() {
            // Calories
            const consumed = appState.todayData.calories;
            const goal = appState.settings.dailyGoal;
            const remaining = goal - consumed;
            
            // Update new SVG donut display
            updateCalorieDisplay(consumed, goal);
            
            // Steps
            document.getElementById('stepsCount').textContent = appState.todayData.steps.toLocaleString();
            const stepsPercent = Math.min(100, (appState.todayData.steps / 10000) * 100);
            document.getElementById('stepsProgress').style.width = stepsPercent + '%';
            
            // Update settings displays
            if (appState.settings.currentWeight) {
                document.getElementById('currentWeightDisplay').textContent = appState.settings.currentWeight.toFixed(1) + ' ◊ß"◊í';
            }
            if (appState.settings.height) {
                document.getElementById('heightDisplay').textContent = appState.settings.height + ' ◊°"◊û';
            }
            if (appState.settings.weight) {
                document.getElementById('weightDisplay').textContent = appState.settings.weight + ' ◊ß"◊í';
            }
            if (appState.settings.age) {
                document.getElementById('ageDisplay').textContent = appState.settings.age + ' ◊©◊†◊ô◊ù';
            }
        }

        // New function to update the advanced SVG donut
        function updateCalorieDisplay(consumed, goal) {
            const remaining = goal - consumed;
            
            // Update Text
            document.getElementById('caloriesConsumedDisplay').textContent = consumed;
            
            const remainingEl = document.getElementById('caloriesRemainingDisplay');
            if (remaining < 0) {
                remainingEl.textContent = `◊¢◊ï◊ì◊£: ${Math.abs(remaining)}`;
                remainingEl.style.color = '#ef4444'; // Red for surplus
                remainingEl.style.textShadow = '0 0 10px rgba(239, 68, 68, 0.4)';
            } else {
                remainingEl.textContent = `◊†◊ï◊™◊®◊ï: ${remaining}`;
                remainingEl.style.color = '#4ade80'; // Green for remaining
                remainingEl.style.textShadow = '0 0 10px rgba(74, 222, 128, 0.4)';
            }
            
            // Update the Advanced Donut SVG
            const circle = document.getElementById('calorieDonutCircle');
            const anim = document.getElementById('donutAnim');
            if (circle && anim) {
                const circumference = 722; // 2 * PI * 115
                const percentage = Math.min(consumed / goal, 1);
                const offset = circumference - (percentage * circumference);
                
                // Update the animation 'to' value so it animates to the correct spot
                anim.setAttribute('to', offset);
                
                // Restart the animation
                anim.beginElement();
            }
        }

        // Saved Meals
        // ========================
        // CUSTOM ICON DROPDOWN
        // ========================

        function renderIconSelector() {
            // Populate both dropdown menus
            [
                { menuId: 'iconDropdownMenu',     hiddenId: 'iconSelector',     selectedId: 'iconDropdownSelected',     dropdownId: 'iconDropdown' },
                { menuId: 'editIconDropdownMenu', hiddenId: 'editIconSelector', selectedId: 'editIconDropdownSelected', dropdownId: 'editIconDropdown' }
            ].forEach(({ menuId, hiddenId, selectedId, dropdownId }) => {
                const menu = document.getElementById(menuId);
                if (!menu) return;
                menu.innerHTML = '';
                foodIcons.forEach(icon => {
                    const li = document.createElement('li');
                    li.className = 'icon-dropdown-item';
                    li.textContent = icon;
                    li.dataset.icon = icon;
                    li.onclick = () => selectDropdownIcon(dropdownId, icon);
                    menu.appendChild(li);
                });
            });
        }

        function toggleIconDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const menu = dropdown.querySelector('.icon-dropdown-menu');
            const isOpen = !menu.classList.contains('hidden');

            // Close all open dropdowns first
            closeAllIconDropdowns();

            if (!isOpen) {
                menu.classList.remove('hidden');
                dropdown.classList.add('open');

                // Smart direction: check if there's enough space below
                const triggerRect = dropdown.getBoundingClientRect();
                const spaceBelow = window.innerHeight - triggerRect.bottom;
                const menuHeight = 192 + 12; // max-height + gap

                if (spaceBelow < menuHeight) {
                    menu.classList.add('opens-up');
                } else {
                    menu.classList.remove('opens-up');
                }
            }
        }

        function selectDropdownIcon(dropdownId, icon) {
            const dropdown = document.getElementById(dropdownId);
            // Update the visible trigger label
            dropdown.querySelector('.icon-dropdown-selected').textContent = icon;
            // Update the hidden input value
            const hiddenInput = dropdown.querySelector('input[type="hidden"]');
            hiddenInput.value = icon;
            // Mark selected item
            dropdown.querySelectorAll('.icon-dropdown-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.icon === icon);
            });
            // Close the menu
            closeAllIconDropdowns();
        }

        function closeAllIconDropdowns() {
            document.querySelectorAll('.icon-dropdown').forEach(d => {
                d.classList.remove('open');
                const menu = d.querySelector('.icon-dropdown-menu');
                menu.classList.add('hidden');
                menu.classList.remove('opens-up');
            });
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.icon-dropdown')) {
                closeAllIconDropdowns();
            }
        });

        function showAddMeal() {
            if (appState.savedMeals.length >= 40) {
                alert('◊î◊í◊¢◊™ ◊ú◊û◊ß◊°◊ô◊û◊ï◊ù 40 ◊û◊†◊ï◊™ ◊ß◊ë◊ï◊¢◊ï◊™');
                return;
            }
            document.getElementById('modalAddMeal').classList.remove('hidden');
        }

        function saveMeal() {
            const name = document.getElementById('newMealName').value;
            const weight = document.getElementById('newMealWeight').value;
            const calories = document.getElementById('newMealCalories').value;
            const icon = document.getElementById('iconSelector').value || 'üçΩÔ∏è';

            if (!name || !weight || !calories) {
                alert('◊†◊ê ◊ú◊û◊ú◊ê ◊ê◊™ ◊õ◊ú ◊î◊©◊ì◊ï◊™');
                return;
            }

            appState.savedMeals.push({
                id: Date.now(),
                name,
                weight: parseInt(weight),
                calories: parseInt(calories),
                icon
            });

            renderSavedMeals();
            saveState();
            closeModal('modalAddMeal');
            
            // Reset form
            document.getElementById('newMealName').value = '';
            document.getElementById('newMealWeight').value = '';
            document.getElementById('newMealCalories').value = '';
            // Reset dropdown to first icon
            selectDropdownIcon('iconDropdown', foodIcons[0]);
        }

        function renderSavedMeals() {
            const list = document.getElementById('savedMealsList');
            list.innerHTML = '';

            if (appState.savedMeals.length === 0) {
                list.innerHTML = '<div class="text-white opacity-60 text-center py-8">◊ê◊ô◊ü ◊û◊†◊ï◊™ ◊ß◊ë◊ï◊¢◊ï◊™</div>';
                document.getElementById('mealCount').textContent = '0';
                return;
            }

            appState.savedMeals.forEach(meal => {
                // Ensure old meals have icons
                if (!meal.icon) {
                    meal.icon = 'üçΩÔ∏è';
                }
                
                const div = document.createElement('div');
                div.className = 'meal-item';
                div.dataset.id = meal.id; // Add data-id for sortable
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="drag-handle cursor-move text-white opacity-40 hover:opacity-70 transition-opacity">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <circle cx="9" cy="5" r="1.5"/>
                                    <circle cx="15" cy="5" r="1.5"/>
                                    <circle cx="9" cy="12" r="1.5"/>
                                    <circle cx="15" cy="12" r="1.5"/>
                                    <circle cx="9" cy="19" r="1.5"/>
                                    <circle cx="15" cy="19" r="1.5"/>
                                </svg>
                            </div>
                            <div class="text-3xl">${meal.icon}</div>
                            <div>
                                <div class="text-white font-semibold">${meal.name}</div>
                                <div class="text-white opacity-70 text-sm">${meal.weight}g ‚Ä¢ ${meal.calories} ◊ß◊ú◊ï◊®◊ô◊ï◊™</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editMeal(${meal.id})" class="btn-secondary text-sm px-3 py-1">◊¢◊®◊ï◊ö</button>
                            <button onclick="deleteMeal(${meal.id})" class="delete-btn text-sm px-3 py-1">◊û◊ó◊ß</button>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });

            document.getElementById('mealCount').textContent = appState.savedMeals.length;
            
            // Initialize Sortable after rendering
            initSortable();
        }

        function deleteMeal(id) {
            if (confirm('◊ú◊û◊ó◊ï◊ß ◊û◊†◊î ◊ñ◊ï?')) {
                appState.savedMeals = appState.savedMeals.filter(m => m.id !== id);
                renderSavedMeals();
                saveState();
            }
        }

        // Initialize Sortable for drag & drop reordering
        function initSortable() {
            const list = document.getElementById('savedMealsList');
            
            // Destroy existing Sortable instance if exists
            if (list.sortableInstance) {
                list.sortableInstance.destroy();
            }
            
            list.sortableInstance = Sortable.create(list, {
                // ‚îÄ‚îÄ Visual classes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                ghostClass:    'sortable-ghost',   // hollow placeholder
                dragClass:     'sortable-drag',    // the floating clone
                chosenClass:   'sortable-chosen',  // original item while dragging
                fallbackClass: 'sortable-drag',    // fallback = same style

                // ‚îÄ‚îÄ Physics ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                animation: 250,          // sibling slide speed (ms)
                easing: 'cubic-bezier(0.2, 0, 0, 1.6)', // springy overshoot
                forceFallback: true,     // required for dragClass to apply

                // ‚îÄ‚îÄ Touch feel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              
                touchStartThreshold: 5,  // px of movement allowed during delay
                handle: '.drag-handle',
                fallbackTolerance: 3,

                // Lift: animate item "up" when grab starts
                onChoose: function(evt) {
                    evt.item.style.willChange = 'transform, box-shadow';
                },

                // Drop: clean up inline styles so CSS takes over
                onUnchoose: function(evt) {
                    evt.item.style.willChange = '';
                    evt.item.style.transform  = '';
                    evt.item.style.boxShadow  = '';
                    evt.item.style.opacity    = '';
                },

                // Persist new order to appState
                onEnd: function(evt) {
                    evt.item.style.willChange = '';
                    evt.item.style.transform  = '';
                    evt.item.style.boxShadow  = '';
                    evt.item.style.opacity    = '';

                    const newOrder = [];
                    list.querySelectorAll('.meal-item').forEach(item => {
                        const id   = parseInt(item.dataset.id);
                        const meal = appState.savedMeals.find(m => m.id === id);
                        if (meal) newOrder.push(meal);
                    });
                    appState.savedMeals = newOrder;
                    saveState();
                }
            });
        }

        // CSV Import Function with Hebrew encoding support
        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            // First, try to read as ArrayBuffer to detect encoding
            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                const uint8Array = new Uint8Array(arrayBuffer);
                
                // Try to decode with different encodings
                let csvContent = '';
                
                // Check if it's UTF-8 (first few bytes won't have high values for Hebrew in UTF-8)
                const hasHighBytes = uint8Array.some(byte => byte > 127);
                
                if (hasHighBytes) {
                    // Likely Windows-1255 (Hebrew)
                    try {
                        const decoder = new TextDecoder('windows-1255');
                        csvContent = decoder.decode(uint8Array);
                    } catch (err) {
                        // Fallback to UTF-8
                        const decoder = new TextDecoder('utf-8');
                        csvContent = decoder.decode(uint8Array);
                    }
                } else {
                    // Regular UTF-8 or ASCII
                    const decoder = new TextDecoder('utf-8');
                    csvContent = decoder.decode(uint8Array);
                }

                // Now process the CSV
                processCSV(csvContent);
                
                // Reset file input
                event.target.value = '';
            };

            reader.onerror = function() {
                showNotification('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊ß◊®◊ô◊ê◊™ ◊î◊ß◊ï◊ë◊•');
                event.target.value = '';
            };

            reader.readAsArrayBuffer(file);
        }

        // Process CSV content
        function processCSV(csvContent) {
            try {
                const lines = csvContent.split('\n');
                let importedCount = 0;
                let skippedCount = 0;

                lines.forEach((line, index) => {
                    // Skip empty lines
                    if (!line.trim()) {
                        return;
                    }

                    // Parse CSV line
                    const parts = line.split(',').map(part => part.trim());
                    
                    if (parts.length < 3) {
                        skippedCount++;
                        return;
                    }

                    const name = parts[0];
                    const weight = parseFloat(parts[1]);
                    const calories = parseFloat(parts[2]);

                    // Validate data
                    if (!name || isNaN(weight) || isNaN(calories) || weight <= 0 || calories <= 0) {
                        skippedCount++;
                        return;
                    }

                    // Check if we've reached the 20 meal limit
                    if (appState.savedMeals.length >= 40) {
                        showNotification('‚ö†Ô∏è ◊î◊í◊¢◊™ ◊ú◊û◊ß◊°◊ô◊û◊ï◊ù 40 ◊û◊†◊ï◊™. ◊ó◊ú◊ß ◊û◊î◊û◊†◊ï◊™ ◊ú◊ê ◊ô◊ï◊ë◊ê◊ï.');
                        return;
                    }

                    // Create new meal object
                    const newMeal = {
                        id: Date.now() + Math.random() * 1000 + index, // Unique ID
                        name: name,
                        weight: weight,
                        calories: calories,
                        icon: 'üçΩÔ∏è' // Default icon
                    };

                    // Add to saved meals
                    appState.savedMeals.push(newMeal);
                    importedCount++;
                });

                // Update UI and save
                if (importedCount > 0) {
                    renderSavedMeals();
                    saveState();
                    showNotification(`‚úÖ ◊ô◊ï◊ë◊ê◊ï ${importedCount} ◊û◊†◊ï◊™ ◊ë◊î◊¶◊ú◊ó◊î!` + (skippedCount > 0 ? ` (${skippedCount} ◊©◊ï◊®◊ï◊™ ◊ì◊ï◊ú◊í◊ï)` : ''));
                } else {
                    showNotification('‚ùå ◊ú◊ê ◊†◊û◊¶◊ê◊ï ◊û◊†◊ï◊™ ◊™◊ß◊ô◊†◊ï◊™ ◊ú◊ô◊ô◊ë◊ï◊ê');
                }

            } catch (error) {
                console.error('CSV Import Error:', error);
                showNotification('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊¢◊ô◊ë◊ï◊ì ◊ß◊ï◊ë◊• CSV');
            }
        }

        let editingMealId = null;
        // editSelectedIcon removed - icon now read directly from dropdown

        function editMeal(id) {
            const meal = appState.savedMeals.find(m => m.id === id);
            if (!meal) return;

            editingMealId = id;

            document.getElementById('editMealName').value = meal.name;
            document.getElementById('editMealWeight').value = meal.weight;
            document.getElementById('editMealCalories').value = meal.calories;

            // Set the custom dropdown to the meal's current icon
            selectDropdownIcon('editIconDropdown', meal.icon || 'üçΩÔ∏è');

            document.getElementById('modalEditMeal').classList.remove('hidden');
        }

        function updateMeal() {
            const name = document.getElementById('editMealName').value;
            const weight = document.getElementById('editMealWeight').value;
            const calories = document.getElementById('editMealCalories').value;
            const icon = document.getElementById('editIconSelector').value || 'üçΩÔ∏è';

            if (!name || !weight || !calories) {
                alert('◊†◊ê ◊ú◊û◊ú◊ê ◊ê◊™ ◊õ◊ú ◊î◊©◊ì◊ï◊™');
                return;
            }

            const mealIndex = appState.savedMeals.findIndex(m => m.id === editingMealId);
            if (mealIndex !== -1) {
                appState.savedMeals[mealIndex] = {
                    id: editingMealId,
                    name,
                    weight: parseInt(weight),
                    calories: parseInt(calories),
                    icon
                };

                renderSavedMeals();
                saveState();
                closeModal('modalEditMeal');
                showNotification('◊î◊û◊†◊î ◊¢◊ï◊ì◊õ◊†◊î ◊ë◊î◊¶◊ú◊ó◊î! ‚úì');
            }
        }

        // Daily Tracking
        function showAddManual() {
            document.getElementById('modalAddManual').classList.remove('hidden');
        }

        async function addManualMeal() {
            const name = document.getElementById('manualMealName').value;
            const calories = document.getElementById('manualMealCalories').value;

            if (!name || !calories) {
                alert('◊†◊ê ◊ú◊û◊ú◊ê ◊ú◊§◊ó◊ï◊™ ◊©◊ù ◊ï◊ß◊ú◊ï◊®◊ô◊ï◊™');
                return;
            }

            await addMealToToday({
                name,
                calories: parseInt(calories),
                icon: 'üçΩÔ∏è',
                time: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })
            });

            closeModal('modalAddManual');
            
            // Reset form
            document.getElementById('manualMealName').value = '';
            document.getElementById('manualMealCalories').value = '';
        }

        function showAddFromSaved() {
            if (appState.savedMeals.length === 0) {
                alert('◊ê◊ô◊ü ◊û◊†◊ï◊™ ◊ß◊ë◊ï◊¢◊ï◊™. ◊¶◊ï◊® ◊û◊†◊î ◊ó◊ì◊©◊î ◊™◊ó◊ô◊ú◊î.');
                return;
            }

            const container = document.getElementById('savedMealsSelect');
            container.innerHTML = '';

            appState.savedMeals.forEach(meal => {
                const div = document.createElement('div');
                div.className = 'meal-item';
                div.onclick = () => addSavedMealToToday(meal);
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-2xl">${meal.icon}</div>
                        <div>
                            <div class="text-white font-semibold">${meal.name}</div>
                            <div class="text-white opacity-70 text-sm">${meal.weight}g ‚Ä¢ ${meal.calories} ◊ß◊ú◊ï◊®◊ô◊ï◊™</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            document.getElementById('modalAddFromSaved').classList.remove('hidden');
            // Add to history so back button can close the modal
            history.pushState({ modal: 'modalAddFromSaved' }, '', window.location.href);
        }

        async function addSavedMealToToday(meal) {
            await addMealToToday({
                name: meal.name,
                calories: meal.calories,
                protein: Math.round(meal.weight * 0.2), // Estimate 20% protein
                icon: meal.icon || 'üçΩÔ∏è', // Use meal icon or default
                time: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })
            });
            closeModal('modalAddFromSaved');
        }

        async function addMealToToday(meal) {
            console.log('üçΩÔ∏è addMealToToday called with:', meal);
            
            // Ensure icon exists
            if (!meal.icon) {
                meal.icon = 'üçΩÔ∏è';
            }
            
            // Add quantity property (default 1.0) and store baseCalories
            if (!meal.quantity) {
                meal.quantity = 1.0;
            }
            if (!meal.baseCalories) {
                meal.baseCalories = meal.calories; // Store original calories
            }
            
            appState.todayData.meals.push(meal);
            appState.todayData.calories += meal.calories;
            
            console.log('   Total meals now:', appState.todayData.meals.length);
            console.log('   Total calories now:', appState.todayData.calories);
            
            renderTodayMeals();
            updateHomeScreen();
            syncTodayToWeekly(); // Sync to dashboard + update chart immediately
            updateWeeklyChart(); // Explicit call to ensure chart updates in background
            
            console.log('   Calling saveState...');
            // Wait for save to complete
            await saveState();
            console.log('   saveState completed');
            
            // Show success feedback
            showNotification('◊î◊û◊†◊î ◊†◊ï◊°◊§◊î ◊ë◊î◊¶◊ú◊ó◊î! ‚úì');
        }
        
        // Simple notification system
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(79, 172, 254, 0.95);
                color: white;
                padding: 12px 24px;
                border-radius: 12px;
                font-weight: 600;
                z-index: 9999;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                animation: slideDown 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        function renderTodayMeals() {
            const container = document.getElementById('todayMeals');
            
            if (!container) {
                console.error('todayMeals container not found');
                return;
            }
            
            container.innerHTML = '';

            if (!appState.todayData.meals || appState.todayData.meals.length === 0) {
                container.innerHTML = '<div class="text-white opacity-60 text-center py-8">◊¢◊ì◊ô◊ô◊ü ◊ú◊ê ◊†◊ï◊°◊§◊ï ◊û◊†◊ï◊™ ◊ú◊î◊ô◊ï◊ù</div>';
                return;
            }

            appState.todayData.meals.forEach((meal, index) => {
                // Ensure quantity exists (for old data)
                if (!meal.quantity) meal.quantity = 1.0;
                if (!meal.baseCalories) meal.baseCalories = meal.calories;
                
                const div = document.createElement('div');
                div.className = 'meal-item';
                
                // Show quantity if not 1.0
                const quantityText = meal.quantity !== 1.0 ? ` (√ó${meal.quantity.toFixed(1)})` : '';
                
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="text-3xl">${meal.icon || 'üçΩÔ∏è'}</div>
                            <div>
                                <div class="text-white font-semibold">${meal.name}${quantityText}</div>
                                <div class="text-white opacity-70 text-sm">${meal.calories} ◊ß◊ú◊ï◊®◊ô◊ï◊™ ‚Ä¢ ${meal.time}</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editMealQuantity(${index})" class="btn-secondary text-sm px-3 py-1">◊¢◊®◊ï◊ö</button>
                            <button onclick="removeMealFromToday(${index})" class="delete-btn text-sm px-3 py-1">◊î◊°◊®</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function removeMealFromToday(index) {
            const meal = appState.todayData.meals[index];
            appState.todayData.calories -= meal.calories;
            appState.todayData.meals.splice(index, 1);
            
            renderTodayMeals();
            updateHomeScreen();
            syncTodayToWeekly(); // Sync to dashboard + update chart immediately
            updateWeeklyChart(); // Explicit call to ensure chart updates in background
            await saveState();
        }

        // Weekly Dashboard
        function updateWeeklyChart() {
            try {
                // Always check and fix week structure when viewing dashboard
                fixWeekDataStructure();
                
                const weekIndex = appState.weeklyData.currentWeek;
                const weekData = appState.weeklyData.weeks[weekIndex] || Array(7).fill({ calories: 0, tdee: 2000 });
                
                // Get TDEE value
                const weekTdee = (weekData[0]?.tdee && weekData[0].tdee !== 0) 
                    ? weekData[0].tdee 
                    : (appState.settings.dailyGoal || 2000);
                
                console.log('üìä Using Sunday TDEE:', weekData[0]?.tdee, 'Final weekTdee:', weekTdee);
                
                // Update TDEE display text
                document.getElementById('tdeeDisplay').textContent = weekTdee;
            
            // ===== SVG CHART RENDERING =====
            const svg = document.getElementById('weeklyChartSVG');
            const barsGroup = document.getElementById('weeklyBarsGroup');
            const tdeeGroup = document.getElementById('tdeeLineGroup');
            const tdeeLabel = document.getElementById('tdeeLineLabel');
            
            if (!svg || !barsGroup || !tdeeGroup) {
                console.error('‚ùå SVG chart elements not found:', { svg: !!svg, barsGroup: !!barsGroup, tdeeGroup: !!tdeeGroup });
                return;
            }
            
            console.log('üìä Rendering weekly chart with data:', weekData);
            
            // Clear previous bars
            barsGroup.innerHTML = '';

            // Constants for SVG Coordinate System (viewBox: 0 0 370 220)
            const chartBottomY = 180;
            const chartTopY = 15;     
            // Round to nearest 100
            const maxDataValue = Math.round((weekTdee + 300) / 100) * 100; // Dynamic: TDEE + 300, rounded to nearest 100
            const startX = 65;
            const barWidth = 28; // Increased from 20 to 28
            const spacingX = 40;
            
            console.log('üìä Max Y-axis value:', maxDataValue, '(TDEE:', weekTdee, ')');

            // Update TDEE Line Position
            let tdeeY = chartBottomY - (weekTdee / maxDataValue * (chartBottomY - chartTopY));
            tdeeY = Math.max(chartTopY, Math.min(chartBottomY, tdeeY)); // Clamp inside chart
            
            // The static HTML drew the line at Y=70, so we transform relative to that
            tdeeGroup.setAttribute('transform', `translate(0, ${tdeeY - 70})`);
            
            // Update TDEE label text
            tdeeLabel.textContent = weekTdee;
            
            // Calculate grid line values (5 lines total: 0, 1/4, 1/2, 3/4, max)
            const gridValues = [
                0,
                Math.round(maxDataValue / 4),
                Math.round(maxDataValue / 2),
                Math.round(maxDataValue * 3 / 4),
                maxDataValue
            ];
            
            console.log('üìä Grid values:', gridValues);
            
            // Update Y-axis labels dynamically (bottom to top in DOM order)
            const yAxisTexts = svg.querySelectorAll('.y-axis-text');
            if (yAxisTexts.length >= 5) {
                yAxisTexts[0].textContent = gridValues[0]; // Bottom: 0%
                yAxisTexts[1].textContent = gridValues[1]; // 25%
                yAxisTexts[2].textContent = gridValues[2]; // 50%
                yAxisTexts[3].textContent = gridValues[3]; // 75%
                yAxisTexts[4].textContent = gridValues[4]; // Top: 100%
            }
            
            // Render Bars and X-Axis Labels
            weekData.forEach((dayData, dayIndex) => {
                const calories = dayData.calories || 0;
                
                // Calculate Bar Height
                const cappedCalories = Math.min(calories, maxDataValue);
                const barHeight = (cappedCalories / maxDataValue) * (chartBottomY - chartTopY);
                const posX = startX + (dayIndex * spacingX);
                
                // Ensure minimum height of 2px so days with 0 calories are visible
                const finalHeight = Math.max(2, barHeight);
                const finalY = chartBottomY - finalHeight;

                // Create a Group for the Bar + Label to make clicking easier
                const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
                group.setAttribute("class", "bar-group");
                
                // CRITICAL: Attach the existing click handler here
                group.addEventListener('click', () => {
                    showDayDetail(dayIndex);
                });
                
                // Add tooltip on hover
                const tooltip = document.getElementById('chartTooltip');
                group.addEventListener('mouseenter', (e) => {
                    if (calories > 0) {
                        tooltip.textContent = `${calories.toLocaleString()} ◊ß◊ú◊ï◊®◊ô◊ï◊™`;
                        tooltip.classList.add('visible');
                    }
                });
                
                group.addEventListener('mousemove', (e) => {
                    if (calories > 0) {
                        const container = document.getElementById('weeklyChartSVGContainer');
                        const rect = container.getBoundingClientRect();
                        tooltip.style.left = (e.clientX - rect.left + 10) + 'px';
                        tooltip.style.top = (e.clientY - rect.top - 30) + 'px';
                    }
                });
                
                group.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });

                // Draw the Bar (rect)
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", posX);
                rect.setAttribute("y", finalY);
                rect.setAttribute("width", barWidth);
                rect.setAttribute("height", finalHeight);
                rect.setAttribute("rx", "6");
                rect.setAttribute("fill", "url(#solidGrad)");
                
                // Only apply glow to bars with data
                if (calories > 0) {
                    rect.setAttribute("filter", "url(#softGlow)");
                }
                
                // Add entry animation with delay
                rect.style.animation = `growUp ${0.6 + (dayIndex * 0.1)}s ease-out forwards`;

                // Draw the X-Axis Label (Day name in Hebrew)
                const dayNames = ['◊ê\'', '◊ë\'', '◊í\'', '◊ì\'', '◊î\'', '◊ï\'', '◊©\''];
                const dayName = dayNames[dayIndex];
                
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", posX + (barWidth / 2));
                text.setAttribute("y", 200); 
                text.setAttribute("text-anchor", "middle");
                text.setAttribute("class", "axis-text");
                text.textContent = dayName;
                
                // Invisible hit-box spanning the whole column height for better mobile tapping
                const hitBox = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                hitBox.setAttribute("x", posX - 10);
                hitBox.setAttribute("y", chartTopY);
                hitBox.setAttribute("width", barWidth + 20);
                hitBox.setAttribute("height", chartBottomY - chartTopY + 30);
                hitBox.setAttribute("fill", "transparent");

                // Append to group
                group.appendChild(hitBox);
                group.appendChild(rect);
                group.appendChild(text);
                
                // Append group to chart
                barsGroup.appendChild(group);
            });

            // Update summary calculations
            // Only count days with data (calories > 0) AND that have ended (date < today in Israel time)
            
            // Get current date/time in Israel (UTC+2)
            const nowUTC = new Date();
            const israelOffset = 2 * 60; // UTC+2 in minutes
            const nowIsrael = new Date(nowUTC.getTime() + israelOffset * 60 * 1000);
            const todayIsrael = new Date(nowIsrael.getFullYear(), nowIsrael.getMonth(), nowIsrael.getDate());
            
            // Filter: only completed days with data
            const completedDaysWithData = weekData.filter(d => {
                if (d.calories <= 0) return false; // No data
                const dayDate = new Date(d.date);
                const dayDateOnly = new Date(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate());
                return dayDateOnly < todayIsrael; // Day has ended
            });
            
            const total = completedDaysWithData.reduce((sum, d) => sum + d.calories, 0);
            const daysCount = completedDaysWithData.length;
            const avg = daysCount > 0 ? Math.round(total / daysCount) : 0;
            
            // Calculate deficit/surplus: (TDEE √ó days) - actual calories
            const expectedCalories = weekTdee * daysCount;
            const deficit = expectedCalories - total; // Positive = deficit (good), Negative = surplus (bad)
            
            document.getElementById('avgDaily').textContent = avg + ' ◊ß◊ú◊ï◊®◊ô◊ï◊™';
            document.getElementById('totalWeekly').textContent = total.toLocaleString() + ' ◊ß◊ú◊ï◊®◊ô◊ï◊™';
            
            // Display deficit/surplus with color coding
            const deficitEl = document.getElementById('weeklyDeficit');
            if (deficit > 0) {
                // Deficit (good) - green
                deficitEl.innerHTML = `<span dir="ltr">-${deficit.toLocaleString()}</span> ◊ß◊ú◊ï◊®◊ô◊ï◊™`;
                deficitEl.style.color = '#4ade80';
            } else if (deficit < 0) {
                // Surplus (bad) - red
                deficitEl.innerHTML = `<span dir="ltr">+${Math.abs(deficit).toLocaleString()}</span> ◊ß◊ú◊ï◊®◊ô◊ï◊™`;
                deficitEl.style.color = 'rgba(239, 68, 68, 0.9)';
            } else {
                // Exactly on target
                deficitEl.innerHTML = '<span dir="ltr">0</span> ◊ß◊ú◊ï◊®◊ô◊ï◊™';
                deficitEl.style.color = 'white';
            }
            
            console.log('üìä Summary: days:', daysCount, 'total:', total, 'expected:', expectedCalories, 'deficit:', deficit);

            // Update week display
            updateWeekDisplay();
            
            } catch (error) {
                console.error('‚ùå Error in updateWeeklyChart:', error);
                console.error('Stack:', error.stack);
            }
        }

        function updateWeekDisplay() {
            const today = new Date();
            const weekIndex = appState.weeklyData.currentWeek || 0;
            
            // Calculate the start of the current week (this Sunday)
            const todayDayOfWeek = today.getDay(); // 0 = Sunday
            const currentWeekSunday = new Date(today);
            currentWeekSunday.setDate(today.getDate() - todayDayOfWeek);
            
            // Go back by weekIndex weeks (0 = current, 1 = last week, 2 = 2 weeks ago, etc.)
            const startDate = new Date(currentWeekSunday);
            startDate.setDate(currentWeekSunday.getDate() - (weekIndex * 7));
            
            // End date is 6 days after start (Saturday)
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);

            const format = (date) => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2); // Last 2 digits of year
                return `${day}/${month}/${year}`;
            };

            document.getElementById('weekDisplay').textContent = 
                `${format(startDate)} - ${format(endDate)}`;
        }

        function previousWeek() {
            // Go to an older week (increase index: 0->1, 1->2, etc.)
            // Maximum 4 weeks back (index 0-4)
            if (appState.weeklyData.currentWeek < 4) {
                appState.weeklyData.currentWeek++;
                updateWeeklyChart();
                console.log(`üìä Viewing week index: ${appState.weeklyData.currentWeek}`);
            }
        }

        function nextWeek() {
            // Go to a newer week (decrease index: 2->1, 1->0)
            // Minimum is current week (index 0)
            if (appState.weeklyData.currentWeek > 0) {
                appState.weeklyData.currentWeek--;
                updateWeeklyChart();
                console.log(`üìä Viewing week index: ${appState.weeklyData.currentWeek}`);
            }
        }

        // Show detailed view for a specific day
        function showDayDetail(dayIndex) {
            const weekIndex = appState.weeklyData.currentWeek || 0;
            const dayData = appState.weeklyData.weeks[weekIndex][dayIndex];
            
            if (!dayData || dayData.calories === 0) {
                showNotification('◊ê◊ô◊ü ◊†◊™◊ï◊†◊ô◊ù ◊ú◊ô◊ï◊ù ◊ñ◊î');
                return;
            }

            // Hide chart and summary
            document.querySelector('.glass-card:has(#weeklyChartSVG)').classList.add('hidden');
            document.getElementById('weeklySummarySection').classList.add('hidden');
            
            // Show day detail view
            document.getElementById('dayDetailView').classList.remove('hidden');
            
            // Format date and day name
            const dayNames = ['◊®◊ê◊©◊ï◊ü', '◊©◊†◊ô', '◊©◊ú◊ô◊©◊ô', '◊®◊ë◊ô◊¢◊ô', '◊ó◊û◊ô◊©◊ô', '◊©◊ô◊©◊ô', '◊©◊ë◊™'];
            const date = new Date(dayData.date);
            const dayName = dayNames[dayIndex];
            const dateStr = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
            
            // Update title
            document.getElementById('dayDetailTitle').textContent = `◊ô◊ï◊ù ${dayName}, ${dateStr}`;
            document.getElementById('dayDetailCalories').textContent = dayData.calories;
            document.getElementById('dayDetailProtein').textContent = dayData.protein || 0;
            
            // Render meals
            const mealsContainer = document.getElementById('dayDetailMeals');
            mealsContainer.innerHTML = '';
            
            if (!dayData.meals || dayData.meals.length === 0) {
                mealsContainer.innerHTML = '<div class="text-white opacity-60 text-center py-4">◊ê◊ô◊ü ◊û◊†◊ï◊™ ◊ú◊ô◊ï◊ù ◊ñ◊î</div>';
                return;
            }
            
            dayData.meals.forEach((meal, mealIndex) => {
                const div = document.createElement('div');
                div.className = 'meal-item';
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3 flex-1">
                            <div class="text-3xl">${meal.icon || 'üçΩÔ∏è'}</div>
                            <div class="flex-1">
                                <div class="text-white font-semibold">${meal.name}</div>
                                <div class="text-white opacity-70 text-sm">
                                    ${meal.calories} ◊ß◊ú◊ï◊®◊ô◊ï◊™ ‚Ä¢ ${meal.protein}g ◊ó◊ú◊ë◊ï◊ü ‚Ä¢ ${meal.time}
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteDayMeal(${weekIndex}, ${dayIndex}, ${mealIndex})" class="text-red-400 hover:text-red-300 p-2 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `;
                mealsContainer.appendChild(div);
            });
        }

        function closeDayDetail() {
            // Show chart and summary
            document.querySelector('.glass-card:has(#weeklyChartSVG)').classList.remove('hidden');
            document.getElementById('weeklySummarySection').classList.remove('hidden');
            
            // Hide day detail view
            document.getElementById('dayDetailView').classList.add('hidden');
        }

        async function deleteDayMeal(weekIndex, dayIndex, mealIndex) {
            if (!confirm('◊î◊ê◊ù ◊ú◊û◊ó◊ï◊ß ◊ê◊™ ◊î◊û◊†◊î?')) return;

            const dayData = appState.weeklyData.weeks[weekIndex][dayIndex];
            if (!dayData || !dayData.meals) return;

            // Remove meal from array
            const deletedMeal = dayData.meals[mealIndex];
            dayData.meals.splice(mealIndex, 1);

            // Recalculate calories and protein
            dayData.calories = dayData.meals.reduce((sum, m) => sum + (m.calories || 0), 0);
            dayData.protein = dayData.meals.reduce((sum, m) => sum + (m.protein || 0), 0);

            // Update in Supabase
            const userId = getUserId();
            if (userId && supabaseClient) {
                try {
                    await supabaseClient
                        .from('daily_logs')
                        .update({
                            total_calories: dayData.calories,
                            protein: dayData.protein,
                            meals: dayData.meals,
                            updated_at: new Date().toISOString()
                        })
                        .eq('user_id', userId)
                        .eq('date', dayData.date);
                    
                    console.log(`‚úÖ Meal deleted from ${dayData.date}`);
                } catch (error) {
                    console.error('‚ùå Error deleting meal:', error);
                }
            }

            // Refresh the view
            showDayDetail(dayIndex);
            updateWeeklyChart();
            showNotification('◊î◊û◊†◊î ◊†◊û◊ó◊ß◊î');
        }

        // Settings - Height/Weight/Age Pickers
        function openHeightPicker() {
            const wheel = document.getElementById('heightWheel');
            wheel.innerHTML = '';
            
            // Create height options from 140cm to 220cm
            for (let i = 140; i <= 220; i++) {
                const div = document.createElement('div');
                div.className = 'step-option';
                div.textContent = i;
                div.dataset.value = i;
                wheel.appendChild(div);
            }
            
            document.getElementById('modalHeightPicker').classList.remove('hidden');
            
            // Scroll to current value or default (170)
            const currentHeight = appState.settings.height || 170;
            const targetIndex = currentHeight - 140;
            setTimeout(() => {
                wheel.scrollTop = targetIndex * 64 - 96;
            }, 100);
            
            setupWheelScroll('heightWheel');
        }

        function openWeightPicker() {
            const wheel = document.getElementById('weightWheel');
            wheel.innerHTML = '';
            
            // Create weight options from 40kg to 200kg with 0.5 increments
            for (let i = 40; i <= 200; i += 0.5) {
                const div = document.createElement('div');
                div.className = 'step-option';
                div.textContent = i % 1 === 0 ? i : i.toFixed(1);
                div.dataset.value = i;
                wheel.appendChild(div);
            }
            
            document.getElementById('modalWeightPicker').classList.remove('hidden');
            
            // Scroll to current value or default (70)
            const currentWeight = appState.settings.weight || 70;
            const targetIndex = (currentWeight - 40) * 2; // *2 because we have 0.5 increments
            setTimeout(() => {
                wheel.scrollTop = targetIndex * 64 - 96;
            }, 100);
            
            setupWheelScroll('weightWheel');
        }

        function openAgePicker() {
            const wheel = document.getElementById('ageWheel');
            wheel.innerHTML = '';
            
            // Create age options from 15 to 100
            for (let i = 15; i <= 100; i++) {
                const div = document.createElement('div');
                div.className = 'step-option';
                div.textContent = i;
                div.dataset.value = i;
                wheel.appendChild(div);
            }
            
            document.getElementById('modalAgePicker').classList.remove('hidden');
            
            // Scroll to current value or default (35)
            const currentAge = appState.settings.age || 35;
            const targetIndex = currentAge - 15;
            setTimeout(() => {
                wheel.scrollTop = targetIndex * 64 - 96;
            }, 100);
            
            setupWheelScroll('ageWheel');
        }

        function confirmHeight() {
            const wheel = document.getElementById('heightWheel');
            const items = wheel.querySelectorAll('.step-option');
            
            // Find the item closest to center
            const containerRect = wheel.getBoundingClientRect();
            const centerY = containerRect.top + containerRect.height / 2;
            
            let closestItem = null;
            let closestDistance = Infinity;
            
            items.forEach(item => {
                const itemRect = item.getBoundingClientRect();
                const itemCenterY = itemRect.top + itemRect.height / 2;
                const distance = Math.abs(centerY - itemCenterY);
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestItem = item;
                }
            });
            
            if (closestItem) {
                const value = parseInt(closestItem.dataset.value);
                appState.settings.height = value;
                document.getElementById('heightDisplay').textContent = value + ' ◊°"◊û';
                closeModal('modalHeightPicker');
                saveState();
            }
        }

        function confirmWeight() {
            const wheel = document.getElementById('weightWheel');
            const items = wheel.querySelectorAll('.step-option');
            
            // Find the item closest to center
            const containerRect = wheel.getBoundingClientRect();
            const centerY = containerRect.top + containerRect.height / 2;
            
            let closestItem = null;
            let closestDistance = Infinity;
            
            items.forEach(item => {
                const itemRect = item.getBoundingClientRect();
                const itemCenterY = itemRect.top + itemRect.height / 2;
                const distance = Math.abs(centerY - itemCenterY);
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestItem = item;
                }
            });
            
            if (closestItem) {
                const value = parseFloat(closestItem.dataset.value);
                appState.settings.weight = value;
                const displayValue = value % 1 === 0 ? value : value.toFixed(1);
                document.getElementById('weightDisplay').textContent = displayValue + ' ◊ß"◊í';
                closeModal('modalWeightPicker');
                saveState();
            }
        }

        function confirmAge() {
            const wheel = document.getElementById('ageWheel');
            const items = wheel.querySelectorAll('.step-option');
            
            // Find the item closest to center
            const containerRect = wheel.getBoundingClientRect();
            const centerY = containerRect.top + containerRect.height / 2;
            
            let closestItem = null;
            let closestDistance = Infinity;
            
            items.forEach(item => {
                const itemRect = item.getBoundingClientRect();
                const itemCenterY = itemRect.top + itemRect.height / 2;
                const distance = Math.abs(centerY - itemCenterY);
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestItem = item;
                }
            });
            
            if (closestItem) {
                const value = parseInt(closestItem.dataset.value);
                appState.settings.age = value;
                document.getElementById('ageDisplay').textContent = value + ' ◊©◊†◊ô◊ù';
                closeModal('modalAgePicker');
                saveState();
            }
        }

        // Current Weight Picker Functions
        function openCurrentWeightPicker() {
            const wheel = document.getElementById('currentWeightWheel');
            wheel.innerHTML = '';
            
            // Create weight options from 40kg to 200kg in 0.5kg increments
            for (let i = 40; i <= 200; i += 0.5) {
                const div = document.createElement('div');
                div.className = 'step-option';
                div.textContent = i.toFixed(1);
                div.dataset.value = i;
                wheel.appendChild(div);
            }
            
            document.getElementById('modalCurrentWeightPicker').classList.remove('hidden');
            
            // Scroll to current weight
            const currentWeight = appState.settings.currentWeight || 70;
            const targetIndex = (currentWeight - 40) * 2; // *2 because we have 0.5 increments
            setTimeout(() => {
                if (wheel.children[targetIndex]) {
                    wheel.children[targetIndex].scrollIntoView({ block: 'center', behavior: 'smooth' });
                }
            }, 100);
        }

        function confirmCurrentWeight() {
            const wheel = document.getElementById('currentWeightWheel');
            const items = wheel.querySelectorAll('.step-option');
            
            // Find the item closest to center
            const containerRect = wheel.getBoundingClientRect();
            const centerY = containerRect.top + containerRect.height / 2;
            
            let closestItem = null;
            let closestDistance = Infinity;
            
            items.forEach(item => {
                const itemRect = item.getBoundingClientRect();
                const itemCenterY = itemRect.top + itemRect.height / 2;
                const distance = Math.abs(centerY - itemCenterY);
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestItem = item;
                }
            });
            
            if (closestItem) {
                const value = parseFloat(closestItem.dataset.value);
                appState.settings.currentWeight = value;
                document.getElementById('currentWeightDisplay').textContent = value.toFixed(1) + ' ◊ß"◊í';
                closeModal('modalCurrentWeightPicker');
                saveState();
            }
        }

        // Quantity Picker Functions
        let editingMealIndex = null;
        let currentQuantity = 1.0;

        function editMealQuantity(mealIndex) {
            editingMealIndex = mealIndex;
            const meal = appState.todayData.meals[mealIndex];
            
            // Ensure meal has quantity
            if (!meal.quantity) meal.quantity = 1.0;
            
            // Set current quantity
            currentQuantity = meal.quantity;
            
            // Update display and open modal
            updateQuantityDisplay();
            document.getElementById('modalQuantityPicker').classList.remove('hidden');
        }

        function updateQuantityDisplay() {
            document.getElementById('quantityDisplay').textContent = currentQuantity.toFixed(1);
        }

        function increaseQuantity() {
            if (currentQuantity < 5.0) {
                currentQuantity = Math.round((currentQuantity + 0.5) * 10) / 10;
                updateQuantityDisplay();
            }
        }

        function decreaseQuantity() {
            if (currentQuantity > 0.5) {
                currentQuantity = Math.round((currentQuantity - 0.5) * 10) / 10;
                updateQuantityDisplay();
            }
        }

        function setQuantity(value) {
            currentQuantity = value;
            updateQuantityDisplay();
        }

        async function confirmQuantity() {
            if (editingMealIndex === null) return;
            
            const meal = appState.todayData.meals[editingMealIndex];
            
            // Store baseCalories if not already stored
            if (!meal.baseCalories) {
                meal.baseCalories = meal.calories;
            }
            
            // Update calories based on new quantity
            const oldCalories = meal.calories;
            const newCalories = Math.round(meal.baseCalories * currentQuantity);
            
            // Update totals
            appState.todayData.calories = appState.todayData.calories - oldCalories + newCalories;
            
            // Update meal
            meal.quantity = currentQuantity;
            meal.calories = newCalories;
            
            // Update UI
            renderTodayMeals();
            updateHomeScreen();
            syncTodayToWeekly(); // Sync to dashboard + update chart immediately
            updateWeeklyChart(); // Explicit call to ensure chart updates in background
            await saveState();
            
            closeModal('modalQuantityPicker');
            showNotification(`◊î◊õ◊û◊ï◊™ ◊¢◊ï◊ì◊õ◊†◊î ◊ú-${currentQuantity.toFixed(1)}`);
            
            editingMealIndex = null;
        }

        function calculateBMR() {
            const height = appState.settings.height;
            const weight = appState.settings.weight;
            const age = appState.settings.age;
            const gender = document.getElementById('bmrGender').value;
            const activity = parseFloat(document.getElementById('bmrActivity').value);

            if (!height || !weight || !age || !gender || !activity) {
                alert('◊†◊ê ◊ú◊û◊ú◊ê ◊ê◊™ ◊õ◊ú ◊î◊©◊ì◊ï◊™');
                return;
            }

            // Mifflin-St Jeor Formula
            let bmr;
            if (gender === 'male') {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }

            const tdee = Math.round(bmr * activity);

            document.getElementById('bmrResult').innerHTML = `
                BMR: ${Math.round(bmr)} ◊ß◊ú◊ï◊®◊ô◊ï◊™<br>
                TDEE: ${tdee} ◊ß◊ú◊ï◊®◊ô◊ï◊™ (◊õ◊ï◊ú◊ú ◊§◊¢◊ô◊ú◊ï◊™)<br>
                <button onclick="useTDEE(${tdee})" class="btn-secondary mt-2">◊î◊©◊™◊û◊© ◊õ◊ô◊¢◊ì ◊ô◊ï◊û◊ô</button>
            `;
        }

        async function useTDEE(tdee) {
            appState.settings.dailyGoal = tdee;
            await saveProfile();
            
            // Update TDEE for all days of the CURRENT ISRAELI WEEK (Sunday-Saturday) in daily_logs
            const now = new Date();
            // Use local date to avoid timezone bugs
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const todayDayOfWeek = today.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
            
            console.log(`üìÖ Setting TDEE for week. Today: ${today.toDateString()} (day ${todayDayOfWeek})`);
            
            // Calculate Sunday of current week
            const weekStartDate = new Date(today);
            weekStartDate.setDate(today.getDate() - todayDayOfWeek); // This week's Sunday
            
            const userId = getUserId();
            if (!userId) {
                showNotification('◊©◊í◊ô◊ê◊î: ◊ú◊ê ◊û◊ó◊ï◊ë◊®');
                return;
            }
            
            // Update all 7 days of Israeli week (Sunday-Saturday)
            const updates = [];
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStartDate);
                dayDate.setDate(weekStartDate.getDate() + i);
                // Format as YYYY-MM-DD in local timezone
                const year = dayDate.getFullYear();
                const month = String(dayDate.getMonth() + 1).padStart(2, '0');
                const day = String(dayDate.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                
                console.log(`  ‚Üí Day ${i}: ${dateStr} (${dayDate.toDateString()})`);
                
                updates.push(
                    supabaseClient
                        .from('daily_logs')
                        .upsert({
                            user_id: userId,
                            date: dateStr,
                            tdee: tdee,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,date',
                            ignoreDuplicates: false
                        })
                );
            }
            
            await Promise.all(updates);
            const endDate = new Date(weekStartDate);
            endDate.setDate(weekStartDate.getDate() + 6); // Saturday
            console.log(`‚úÖ TDEE ${tdee} saved for Israeli week (${weekStartDate.toDateString()} - ${endDate.toDateString()})`);
            
            // Reload weekly data to reflect changes
            await loadWeeklyData();
            updateHomeScreen();
            updateWeeklyChart();
            showNotification('◊î◊ô◊¢◊ì ◊î◊ô◊ï◊û◊ô ◊†◊©◊û◊® ◊ú◊õ◊ú ◊î◊©◊ë◊ï◊¢! üéØ');
        }

        // Modal helpers
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // ========================
        // AI CAMERA FUNCTIONS
        // ========================
        function triggerAICamera() {
            // Opens the rear camera directly on mobile (capture="environment")
            document.getElementById('aiCameraInput').click();
        }

        function triggerAIGallery() {
            // Opens the photo library / file picker (no capture attribute)
            document.getElementById('aiGalleryInput').click();
        }

        function resetAIScan() {
            document.getElementById('aiScanArea').classList.remove('hidden');
            document.getElementById('aiProcessingArea').classList.add('hidden');
            document.getElementById('aiResultArea').classList.add('hidden');
        }

        async function handleAIImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show processing state
            document.getElementById('aiScanArea').classList.add('hidden');
            document.getElementById('aiProcessingArea').classList.remove('hidden');
            document.getElementById('aiResultArea').classList.add('hidden');

            try {
                // Convert image to base64
                const base64Image = await fileToBase64(file);
                
                // Analyze with Gemini AI
                const result = await analyzeImageWithGemini(base64Image);
                
                // Show result (do NOT auto-add to log)
                displayAIResult(result);
                
            } catch (error) {
                console.error('AI Analysis Error:', error);
                showNotification('◊©◊í◊ô◊ê◊î ◊ë◊†◊ô◊™◊ï◊ó ◊î◊™◊û◊ï◊†◊î. ◊†◊°◊î ◊©◊ï◊ë.');
                resetAIScan();
            }

            // Reset file input
            event.target.value = '';
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Remove data:image/...;base64, prefix using regex
                    const base64 = reader.result.replace(/^data:image\/[a-zA-Z]+;base64,/, '');
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        async function analyzeImageWithGemini(base64Image) {
            console.log("üöÄ Calling Secure AI Proxy (Image Mode)...");

            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session?.access_token) {
                showNotification('◊§◊í ◊™◊ï◊ß◊£ ◊î◊î◊™◊ó◊ë◊®◊ï◊™ ‚Äî ◊ê◊†◊ê ◊î◊™◊ó◊ë◊® ◊û◊ó◊ì◊©');
                throw new Error('No active session');
            }

            const response = await fetch(
                `${SUPABASE_URL}/functions/v1/gemini-proxy`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type':  'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey':        SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify({ image: base64Image, mode: 'plate' })
                }
            );

            if (!response.ok) {
                const errText = await response.text();
                console.error('‚ùå Edge function error:', response.status, errText);
                throw new Error(`AI Proxy Error ${response.status}: ${errText}`);
            }

            return await response.json();
        }

        function displayAIResult(result) {
            // Store result for later use by buttons
            lastAIResult = result;
            
            document.getElementById('aiProcessingArea').classList.add('hidden');
            document.getElementById('aiResultArea').classList.remove('hidden');

            const resultContent = document.getElementById('aiResultContent');
            resultContent.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-white opacity-70">◊©◊ù ◊î◊û◊†◊î:</span>
                        <span class="text-white font-bold text-lg">${result.name}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-white opacity-70">◊û◊©◊ß◊ú:</span>
                        <span class="text-white font-bold">${result.weight}g</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-white opacity-70">◊ß◊ú◊ï◊®◊ô◊ï◊™:</span>
                        <span class="text-white font-bold text-xl" style="color: var(--accent-primary);">${result.calories}</span>
                    </div>
                </div>
            `;
        }

        function addMealFromAI(result) {
            const meal = {
                id: Date.now(),
                icon: 'üçΩÔ∏è',
                name: result.name,
                calories: result.calories,
                weight: result.weight,
                time: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })
            };

            appState.todayData.meals.push(meal);
            appState.todayData.calories += result.calories;

            saveState();
            updateHomeScreen();
            renderTodayMeals();
            syncTodayToWeekly();
        }

        // New function: Add to today's log from AI result
        function addToTodayFromAI() {
            if (!lastAIResult) return;
            
            addMealFromAI(lastAIResult);
            
            // Show success notification
            showNotification('◊†◊ï◊°◊£ ◊ë◊î◊¶◊ú◊ó◊î! üéâ');
            
            // Wait a moment for notification, then switch to home screen
            setTimeout(() => {
                showScreen('home');
            }, 800);
        }

        // New function: Save to meal library from AI result
        function saveToLibraryFromAI() {
            if (!lastAIResult) return;
            
            saveAIMealToLibrary(lastAIResult);
            
            // Show success notification
            showNotification('◊†◊ï◊°◊£ ◊ë◊î◊¶◊ú◊ó◊î! üéâ');
            
            // Wait a moment for notification, then switch to home screen
            setTimeout(() => {
                showScreen('home');
            }, 800);
        }

        // New function: Save AI meal to library (savedMeals)
        function saveAIMealToLibrary(result) {
            const savedMeal = {
                id: Date.now(),
                icon: 'üçΩÔ∏è',
                name: result.name,
                calories: result.calories,
                weight: result.weight
            };

            // Add to beginning of array
            appState.savedMeals.unshift(savedMeal);
            
            // Keep only 40 most recent meals
            if (appState.savedMeals.length > 40) {
                appState.savedMeals = appState.savedMeals.slice(0, 40);
            }

            saveState();
            renderSavedMeals();
        }

        // ========================
        // RECIPE MODE FUNCTIONS
        // ========================
        let currentAIMode = 'plate'; // 'plate' or 'recipe'
        let lastRecipeResult = null;

        function switchAIMode(mode) {
            currentAIMode = mode;
            
            // Update button styles
            const plateBtn = document.getElementById('modePlate');
            const recipeBtn = document.getElementById('modeRecipe');
            
            if (mode === 'plate') {
                plateBtn.classList.add('bg-white/10');
                plateBtn.classList.remove('opacity-60');
                recipeBtn.classList.remove('bg-white/10');
                recipeBtn.classList.add('opacity-60');
                
                // Show plate mode, hide recipe mode
                document.getElementById('plateModeContent').classList.remove('hidden');
                document.getElementById('recipeModeContent').classList.add('hidden');
            } else {
                recipeBtn.classList.add('bg-white/10');
                recipeBtn.classList.remove('opacity-60');
                plateBtn.classList.remove('bg-white/10');
                plateBtn.classList.add('opacity-60');
                
                // Show recipe mode, hide plate mode
                document.getElementById('plateModeContent').classList.add('hidden');
                document.getElementById('recipeModeContent').classList.remove('hidden');
            }
        }

        function triggerRecipeImageUpload() {
            document.getElementById('recipeImageInput').click();
        }

        async function analyzeRecipeText() {
            const text = document.getElementById('recipeTextInput').value.trim();
            
            if (!text) {
                alert('◊†◊ê ◊ú◊î◊ñ◊ô◊ü ◊ò◊ß◊°◊ò ◊û◊™◊õ◊ï◊ü');
                return;
            }

            // Show processing state
            document.getElementById('recipeInputArea').classList.add('hidden');
            document.getElementById('recipeProcessingArea').classList.remove('hidden');
            document.getElementById('recipeResultArea').classList.add('hidden');

            try {
                const result = await analyzeRecipeWithGemini(text, 'text');
                displayRecipeResult(result);
            } catch (error) {
                console.error('Recipe Analysis Error:', error);
                showNotification('◊©◊í◊ô◊ê◊î ◊ë◊†◊ô◊™◊ï◊ó ◊î◊û◊™◊õ◊ï◊ü. ◊†◊°◊î ◊©◊ï◊ë.');
                resetRecipeAnalysis();
            }
        }

        async function handleRecipeImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show processing state
            document.getElementById('recipeInputArea').classList.add('hidden');
            document.getElementById('recipeProcessingArea').classList.remove('hidden');
            document.getElementById('recipeResultArea').classList.add('hidden');

            try {
                const base64Image = await fileToBase64(file);
                const result = await analyzeRecipeWithGemini(base64Image, 'image');
                displayRecipeResult(result);
            } catch (error) {
                console.error('Recipe Analysis Error:', error);
                showNotification('◊©◊í◊ô◊ê◊î ◊ë◊†◊ô◊™◊ï◊ó ◊î◊û◊™◊õ◊ï◊ü. ◊†◊°◊î ◊©◊ï◊ë.');
                resetRecipeAnalysis();
            }

            event.target.value = '';
        }

        async function analyzeRecipeWithGemini(input, inputType) {
            console.log("üöÄ Calling Secure AI Proxy (Recipe Mode)...");

            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session?.access_token) {
                showNotification('◊§◊í ◊™◊ï◊ß◊£ ◊î◊î◊™◊ó◊ë◊®◊ï◊™ ‚Äî ◊ê◊†◊ê ◊î◊™◊ó◊ë◊® ◊û◊ó◊ì◊©');
                throw new Error('No active session');
            }

            const requestBody = { mode: 'recipe' };
            if (inputType === 'text') {
                requestBody.text = input;
            } else {
                requestBody.image = input;
            }

            const response = await fetch(
                `${SUPABASE_URL}/functions/v1/gemini-proxy`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type':  'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey':        SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify(requestBody)
                }
            );

            if (!response.ok) {
                const errText = await response.text();
                console.error('‚ùå Edge function error:', response.status, errText);
                throw new Error(`AI Proxy Error ${response.status}: ${errText}`);
            }

            return await response.json();
        }

        function displayRecipeResult(result) {
            lastRecipeResult = result;
            
            document.getElementById('recipeProcessingArea').classList.add('hidden');
            document.getElementById('recipeResultArea').classList.remove('hidden');

            const resultContent = document.getElementById('recipeResultContent');
            resultContent.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <div class="text-white opacity-70 text-sm mb-1">◊©◊ù ◊î◊û◊™◊õ◊ï◊ü:</div>
                        <div class="text-white font-bold text-xl">${result.name}</div>
                    </div>
                    
                    ${result.ingredients ? `
                    <div>
                        <div class="text-white opacity-70 text-sm mb-1">◊®◊õ◊ô◊ë◊ô◊ù:</div>
                        <div class="text-white text-sm">${result.ingredients}</div>
                    </div>
                    ` : ''}
                    
                    <div class="border-t border-white/10 pt-4 space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white opacity-70">◊°◊î"◊õ ◊ß◊ú◊ï◊®◊ô◊ï◊™ ◊ë◊û◊†◊î:</span>
                            <span class="text-white font-bold text-lg">${result.totalCalories}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white opacity-70">◊û◊©◊ß◊ú ◊õ◊ï◊ú◊ú:</span>
                            <span class="text-white font-bold">${result.totalWeight}g</span>
                        </div>
                        <div class="flex justify-between items-center bg-white/5 p-3 rounded-xl">
                            <span class="text-white font-semibold">◊ß◊ú◊ï◊®◊ô◊ï◊™ ◊ú-100 ◊í◊®◊ù:</span>
                            <span class="text-white font-bold text-2xl" style="color: var(--accent-primary);">${result.caloriesPer100g}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function addRecipeToTodayFromAI() {
            if (!lastRecipeResult) return;
            
            const meal = {
                id: Date.now(),
                icon: 'üìñ',
                name: lastRecipeResult.name + ' (100g)',
                calories: lastRecipeResult.caloriesPer100g,
                weight: 100,
                time: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })
            };

            appState.todayData.meals.push(meal);
            appState.todayData.calories += meal.calories;

            saveState();
            updateHomeScreen();
            renderTodayMeals();
            syncTodayToWeekly();
            
            showNotification('◊†◊ï◊°◊£ ◊ë◊î◊¶◊ú◊ó◊î! üéâ');
            
            setTimeout(() => {
                showScreen('home');
            }, 800);
        }

        function saveRecipeToLibraryFromAI() {
            if (!lastRecipeResult) return;
            
            const savedMeal = {
                id: Date.now(),
                icon: 'üìñ',
                name: lastRecipeResult.name + ' (100g)',
                calories: lastRecipeResult.caloriesPer100g,
                weight: 100
            };

            appState.savedMeals.unshift(savedMeal);
            
            if (appState.savedMeals.length > 40) {
                appState.savedMeals = appState.savedMeals.slice(0, 40);
            }

            saveState();
            renderSavedMeals();
            
            showNotification('◊†◊ï◊°◊£ ◊ë◊î◊¶◊ú◊ó◊î! üéâ');
            
            setTimeout(() => {
                showScreen('home');
            }, 800);
        }

        function resetRecipeAnalysis() {
            document.getElementById('recipeInputArea').classList.remove('hidden');
            document.getElementById('recipeProcessingArea').classList.add('hidden');
            document.getElementById('recipeResultArea').classList.add('hidden');
            document.getElementById('recipeTextInput').value = '';
            lastRecipeResult = null;
        }

        // Initialize app
        window.onload = async function() {
            // Both elements start with display:none via inline style fallback
            // (class="hidden" is not reliable when ID CSS rules have higher specificity)
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app').style.display = 'none';

            if (!supabaseClient) {
                // No Supabase ‚Äî go straight to app
                document.getElementById('app').style.display = 'block';
                await init();
                return;
            }

            // ‚îÄ‚îÄ STEP 1: Check for an existing session immediately (returning user) ‚îÄ‚îÄ
            const { data: { session: existingSession } } = await supabaseClient.auth.getSession();
            if (existingSession?.user) {
                currentUser = existingSession.user;
                console.log('üîÑ Session restored for:', currentUser.email);
                showApp();
                await init();
            } else {
                // No session ‚Üí show login
                showAuthScreen();
            }

            // ‚îÄ‚îÄ STEP 2: Keep listening for future login / logout events ‚îÄ‚îÄ
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                console.log('üîê Auth event:', event, '| user:', session?.user?.email ?? 'none');

                if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    setAuthBtnLoading(false);
                    showAuthScreen();
                    return;
                }

                // SIGNED_IN or TOKEN_REFRESHED
                if (session?.user && !currentUser) {
                    // Only act if we weren't already logged in (avoids double-init)
                    currentUser = session.user;
                    setAuthBtnLoading(false);

                    // Create default profile for brand-new sign-ups
                    if (event === 'SIGNED_IN') {
                        const { data: existing } = await supabaseClient
                            .from('profiles')
                            .select('id')
                            .eq('user_id', currentUser.id)
                            .single();
                        if (!existing) {
                            await supabaseClient.from('profiles').insert([{
                                user_id: currentUser.id,
                                daily_calorie_goal: 2000,
                                current_weight: 70,
                                height: null, weight: null, age: null
                            }]);
                            console.log('‚úÖ Default profile created for new user');
                        }
                    }

                    showApp();
                    await init();
                }
            });
        };

        // Handle Android back button - close modals instead of exiting app
        window.addEventListener('popstate', function(event) {
            // Check if any modal is open
            const openModals = [
                'modalAddFromSaved',
                'modalAddManual',
                'modalAddMeal',
                'modalStepsPicker',
                'modalWaterPicker',
                'modalHeightPicker',
                'modalWeightPicker',
                'modalAgePicker'
            ];
            
            for (const modalId of openModals) {
                const modal = document.getElementById(modalId);
                if (modal && !modal.classList.contains('hidden')) {
                    modal.classList.add('hidden');
                    // Prevent going back in history
                    history.pushState(null, '', window.location.href);
                    return;
                }
            }
        });

        // Push initial state to enable back button handling
        history.pushState(null, '', window.location.href);
    </script>
</body>
</html>